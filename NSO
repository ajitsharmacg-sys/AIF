real_choices = [(value, label) for value, label in field.choices if value]

# Add your custom placeholder at top
new_choices = [("", "Select Promo Category")] + real_choices


# ---------- NSO DROPDOWN ----------
orgs = Organization.objects.exclude(
    organization_name__in=["CENV", "CEL"]
).values_list("organization_name", flat=True)

org_choices = [("", "Select NSO")] + [(org, org) for org in orgs]

self.fields["nso"].choices = org_choices
self.fields["nso"].required = True
self.fields["nso"].widget = Select(
    attrs={"class": "form-select form-select-sm"},
    choices=org_choices,
)


# ---------- PROMO CATEGORY DROPDOWN ----------
promo_choices = [("", "Select Promo Category")] + list(self.fields["promotion_category"].choices)

self.fields["promotion_category"].choices = promo_choices
self.fields["promotion_category"].required = True
self.fields["promotion_category"].widget = Select(
    attrs={"class": "form-select form-select-sm"},
    choices=promo_choices,
)





from django.forms import Select

self.fields["promotion_category"].widget = Select(
    attrs={"class": "form-select form-select-sm"},
    choices=self.fields["promotion_category"].choices,
)



{% else %}
    {% if field.field.widget.input_type == "select" or field.field.choices %}
        {{ field|add_attrs:"v-model=aif; class=form-select form-select-sm" }}
    {% else %}
        {{ field|add_attrs:"v-model=aif; class=form-control form-control-sm" }}
    {% endif %}
{% endif %}



onNSOChange(event) {
    const nso = event.target.value;
    if (!nso) return;

    this.isLoading = true;

    const url = `/api/nso-config/?nso__organization_name=${encodeURIComponent(nso)}`;

    fetch(url)
        .then(res => {
            if (!res.ok) return Promise.reject(res);
            return res.json();
        })
        .then(data => {
            const config = data[0];
            const currency = config ? config.currency : "EUR";

            this.aif.local_currency = currency;

            // ✅ Run dependent logic AFTER currency is set
            if (currency === "EUR") {
                this.aif.exchange_rate = 1;
                this.recalculateAllLines();
                this.isLoading = false;
            } else {
                // updateExchangeRate already handles recalculation + errors
                this.updateExchangeRate(true);
            }
        })
        .catch(err => {
            this.display_error(err, "Failed to load NSO configuration");
            this.isLoading = false;
        });
}







from django.db import models
from common.models import Organization


class CurrencyChoices(models.TextChoices):
    EUR = "EUR", "EUR"
    GBP = "GBP", "GBP"
    CHF = "CHF", "CHF"
    SEK = "SEK", "SEK"
    NOK = "NOK", "NOK"
    DKK = "DKK", "DKK"
    PLN = "PLN", "PLN"
    HUF = "HUF", "HUF"
    CZK = "CZK", "CZK"
    RUB = "RUB", "RUB"

class NSOConfiguration(models.Model):

    nso = models.OneToOneField(
        Organization,
        on_delete=models.CASCADE,
        related_name="config",
        limit_choices_to=~models.Q(organization_name__in=["CENV", "CEL"])
    )

    currency = models.CharField(
        max_length=3,
        choices=CurrencyChoices.choices,
        default=CurrencyChoices.EUR
    )

    operation_unit_code = models.CharField(max_length=20)

    def __str__(self):
        return f"{self.nso.organization_name} - {self.currency}"

class NSOConfigurationSerializer(serializers.ModelSerializer):
    nso_name = serializers.CharField(source="nso.organization_name", read_only=True)

    class Meta:
        model = NSOConfiguration
        fields = ["id", "nso", "nso_name", "currency", "operation_unit_code"]
# admin.py

from django.contrib import admin
from .models import NSOConfiguration

@admin.register(NSOConfiguration)
class NSOConfigurationAdmin(admin.ModelAdmin):
    list_display = ("nso", "currency", "operation_unit_code")
    list_filter = ("currency",)
    search_fields = ("nso__organization_name", "operation_unit_code")

async function loadNSOConfig() {
    const res = await fetch("/api/nso-config/");
    const data = await res.json();

    const nsoConfigMap = {};
    data.forEach(item => {
        nsoConfigMap[item.nso_name] = {
            currency: item.currency,
            operationUnit: item.operation_unit_code + " ITCG ELP On Invoice Promotion (GLB)"
        };
    });

    return nsoConfigMap;
}


# urls.py

from rest_framework.routers import DefaultRouter
from .views import NSOConfigurationViewSet

router = DefaultRouter()
router.register(r'nso-config', NSOConfigurationViewSet, basename='nso-config')

urlpatterns = router.urls


# views.py

# views.py
from rest_framework import viewsets
from .models import NSOConfiguration
from .serializers import NSOConfigurationSerializer

class NSOConfigurationViewSet(viewsets.ReadOnlyModelViewSet):
    queryset = NSOConfiguration.objects.select_related("nso")
    serializer_class = NSOConfigurationSerializer
    filterset_fields = ["nso__organization_name"]



























status_icon(status) {
  switch (status) {
    case "DRAFT":
      return `<i class="bi bi-pencil-square text-secondary"></i>`;

    case "PLANNED":
      return `<i class="bi bi-calendar-check text-primary"></i>`;

    case "AWAITING_VALIDATION":
      return `<i class="bi bi-hourglass-split text-warning"></i>`;

    case "AWAITING_APPROVAL":
      return `<i class="bi bi-hourglass-split text-warning"></i>`;

    case "COMMERCIALLY_APPROVED":
      return `<i class="bi bi-check-circle-fill text-success"></i>`;

    case "APPROVED":
      return `<i class="bi bi-check-circle-fill text-success"></i>`;

    case "INVALID":
      return `<i class="bi bi-x-circle-fill text-danger"></i>`;

    case "REJECTED":
      return `<i class="bi bi-x-circle-fill text-danger"></i>`;

    case "CLOSED":
      return `<i class="bi bi-lock-fill text-warning"></i>`;

    default:
      return `<i class="bi bi-question-circle text-muted"></i>`;
  }
}










<div v-else class="alert alert-secondary py-2 mb-0">
    <span class="text-muted fst-italic small">
        Search by {{ filter_fields.join(', ') }} — Select line to see available action.
    </span>
</div>



<div class="col-4">
    <label class="form-label mb-1 d-flex align-items-center gap-1">
        File Attachment
        <a :href="encodeURI('{{ site_address|safe }}{{ library }}')"
           target="_blank"
           title="File will be uploaded to SharePoint"
           class="d-inline-flex align-items-center ms-1">
            <img src="{% static 'common/img/sharepoint.svg' %}"
                 alt="SharePoint"
                 width="16"
                 height="16">
        </a>
    </label>

    <input type="file" class="form-control form-control-sm">
</div>






class OrganizationConfig(models.Model):
    organization = models.OneToOneField(
        Organization,
        on_delete=models.CASCADE,
        related_name="config"
    )
    currency = models.CharField(max_length=3)
from django.db import migrations

def create_nso_currency_mapping(apps, schema_editor):
    Organization = apps.get_model("common", "Organization")  # adjust app label
    OrganizationConfig = apps.get_model("yourapp", "OrganizationConfig")

    nso_currency_map = {
        "NSO Austria": "EUR",
        "NSO Belgium": "EUR",
        "NSO Czech": "CZK",
        "NSO Denmark": "DKK",
        "NSO Finland": "EUR",
        "NSO France": "EUR",
        "NSO Germany": "EUR",
        "NSO Hungary": "HUF",
        "NSO Ireland": "EUR",
        "NSO Italy": "EUR",
        "NSO Netherlands": "EUR",
        "NSO Norway": "NOK",
        "NSO Poland": "PLN",
        "NSO Portugal": "EUR",
        "NSO Slovakia": "EUR",
        "NSO Spain": "EUR",
        "NSO Sweden": "SEK",
        "NSO Switzerland": "CHF",
        "NSO UK": "GBP",
        "RSO Russia": "RUB",
        "CEL": "EUR",
    }

    for org_name, currency in nso_currency_map.items():
        try:
            org = Organization.objects.get(organization_name=org_name)
            OrganizationConfig.objects.update_or_create(
                organization=org,
                defaults={"currency": currency}
            )
        except Organization.DoesNotExist:
            print(f"Organization not found: {org_name}")


class Migration(migrations.Migration):

    dependencies = [
        ("yourapp", "previous_migration"),
        ("common", "organization_migration"),  # adjust if needed
    ]

    operations = [
        migrations.RunPython(create_nso_currency_mapping),
    ]
