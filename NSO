from aif.roles import PSBD_TEAM_USER

class AifLineView(viewsets.ModelViewSet):
    permission_classes = [IsApplicationUser]
    serializer_class = AifLineSerializer
    filter_backends = [DjangoFilterBackend, filters.SearchFilter, filters.OrderingFilter]
    filterset_fields = {"aif": ["exact"]}

    def get_queryset(self):
        user = self.request.user
        aif_id = self.request.query_params.get("aif")

        base_qs = AifLines.objects.all()

        if not aif_id:
            return base_qs.none()

        # ðŸ”¹ If user is NOT PSBD â†’ show all lines
        if not user.groups.filter(name=PSBD_TEAM_USER).exists():
            return base_qs.filter(aif=aif_id)

        # ðŸ”¹ PSBD user â†’ restrict by product groups assigned
        allowed_groups = AifApprover.objects.filter(
            approver=user
        ).values_list("product_group", flat=True)

        return base_qs.filter(aif=aif_id, product_group__in=allowed_groups)




hasDuplicateMercuries() {
    const mercurySet = new Set();
    const duplicates = new Set();

    for (const line of this.lines) {
        const mercury = line.mercury_code?.trim();
        if (!mercury) continue;

        if (mercurySet.has(mercury)) {
            duplicates.add(mercury);
        } else {
            mercurySet.add(mercury);
        }
    }

    if (duplicates.size > 0) {
        const dupList = Array.from(duplicates).join(", ");

        this.dialog
            .reset_to_default()
            .set_title("Duplicate Mercury Codes")
            .set_message(`Mercury code(s) ${dupList} are entered more than once.`)
            .set_true_action("Close")
            .show();

        return true;
    }

    return false;
}



async paste_mercury_from_excel(line_item, index, event) {
    this.invalidMercuries = [];

    const text = event.clipboardData.getData("text/plain");
    const copied_lines = text.trim().split(/\r?\n/);
    if (!copied_lines.length) return;

    // ðŸ”¹ Step 1: Basic format validation
    for (let i = 0; i < copied_lines.length; i++) {
        const mercury = copied_lines[i].split("\t")[0]?.trim();
        if (!mercury || !/^[a-zA-Z0-9]+$/.test(mercury)) {
            this.showExcelValidationError(i, "Mercury Code must be alphanumeric and not blank.");
            return;
        }
    }

    const rowRefs = [];

    // ðŸ”¹ Step 2: Create rows and paste mercury codes immediately
    for (let i = 0; i < copied_lines.length; i++) {
        const mercury_code = copied_lines[i].split("\t")[0].trim();

        let row;

        // ðŸ‘‰ Reuse current row only if it's empty
        if (i === 0 && !line_item[index]?.mercury_code) {
            row = line_item[index];
        } else {
            line_item.splice(index, 0, {});
            row = line_item[index];
        }

        row.mercury_code = mercury_code;

        if (this.nav_state.context === "edit") {
            row.id = "temp";
        }

        rowRefs.push(row);
        index++; // move to next position
    }

    // ðŸ”¹ Step 3: Validate each mercury via API
    for (const row of rowRefs) {
        const currentIndex = line_item.indexOf(row);
        if (currentIndex === -1) continue; // row already removed
        await this.handle_mercury_change(line_item, currentIndex, row.mercury_code);
    }

    // ðŸ”¹ Step 4: Show one summary error if needed
    if (this.invalidMercuries.length) {
        this.dialog.reset_to_default()
            .set_title("Some Mercury Codes Were Removed")
            .set_message(this.invalidMercuries.join(", "))
            .set_true_action("Close")
            .show();
    }
}







async paste_mercury_from_excel(line_item, startIndex, event) {
    this.invalidMercuries = [];
    const text = event.clipboardData.getData("text/plain");
    const copied_lines = text.trim().split(/\r?\n/);
    if (!copied_lines.length) return;

    // Validate format only
    for (let i = 0; i < copied_lines.length; i++) {
        const mercury = copied_lines[i].split("\t")[0]?.trim();
        if (!mercury || !/^[a-zA-Z0-9]+$/.test(mercury)) {
            this.showExcelValidationError(i, "Mercury Code must be alphanumeric and not blank.");
            return;
        }
    }

    const rowRefs = [];
    let insertIndex = startIndex;

    for (let i = 0; i < copied_lines.length; i++) {
        const mercury_code = copied_lines[i].split("\t")[0].trim();

        // ðŸ‘‰ Use existing empty row for FIRST item
        let row;
        if (i === 0 && !line_item[insertIndex]?.mercury_code) {
            row = line_item[insertIndex];
        } else {
            line_item.splice(insertIndex, 0, {});
            row = line_item[insertIndex];
        }

        row.mercury_code = mercury_code;
        if (this.nav_state.context === "edit") {
            row.id = "temp";
        }

        rowRefs.push(row);
        insertIndex++;
    }

    // Validate each mercury
    for (const row of rowRefs) {
        const currentIndex = line_item.indexOf(row);
        if (currentIndex === -1) continue;
        await this.handle_mercury_change(line_item, currentIndex, row.mercury_code);
    }

    // Show summary if needed
    if (this.invalidMercuries.length) {
        this.dialog.reset_to_default()
            .set_title("Some Mercury Codes Were Removed")
            .set_message(this.invalidMercuries.join(", "))
            .set_true_action("Close")
            .show();
    }
}




async paste_mercury_from_excel(line_item, startIndex, event) {
    this.invalidMercuries = [];
    const text = event.clipboardData.getData("text/plain");
    const copied_lines = text.trim().split(/\r?\n/);
    if (!copied_lines.length) return;

    // 1ï¸âƒ£ Validate format only
    for (let i = 0; i < copied_lines.length; i++) {
        const mercury = copied_lines[i].split("\t")[0]?.trim();
        if (!mercury || !/^[a-zA-Z0-9]+$/.test(mercury)) {
            this.showExcelValidationError(i, "Mercury Code must be alphanumeric and not blank.");
            return;
        }
    }

    // 2ï¸âƒ£ Insert ALL rows immediately (UX improvement)
    const rowRefs = [];
    let insertIndex = startIndex;

    for (let i = 0; i < copied_lines.length; i++) {
        const mercury_code = copied_lines[i].split("\t")[0].trim();

        line_item.splice(insertIndex, 0, {});
        const row = line_item[insertIndex];

        row.mercury_code = mercury_code;
        if (this.nav_state.context === "edit") {
            row.id = "temp";
        }

        rowRefs.push(row);
        insertIndex++;
    }

    // 3ï¸âƒ£ Now validate each mercury asynchronously
    for (const row of rowRefs) {
        const currentIndex = line_item.indexOf(row);
        if (currentIndex === -1) continue; // already deleted earlier

        await this.handle_mercury_change(line_item, currentIndex, row.mercury_code);
    }

    // 4ï¸âƒ£ Final summary message
    if (this.invalidMercuries.length) {
        this.dialog.reset_to_default()
            .set_title("Some Mercury Codes Were Removed")
            .set_message(this.invalidMercuries.join(", "))
            .set_true_action("Close")
            .show();
    }
}













async paste_mercury_from_excel(line_item, startIndex, event) {
    this.invalidMercuries = [];

    const text = event.clipboardData.getData("text/plain");
    const copied_lines = text.trim().split(/\r?\n/);
    if (!copied_lines.length) return;

    const rows = []; // store row object references

    /* -------------------------------
       PASS 1 â€” Create rows & assign mercury
       ------------------------------- */
    let insertOffset = 0;

    for (let i = 0; i < copied_lines.length; i++) {
        const mercury = copied_lines[i].split("\t")[0]?.trim();

        if (!mercury || !/^[a-zA-Z0-9]+$/.test(mercury)) {
            this.invalidMercuries.push(mercury || `(Row ${i + 1})`);
            continue;
        }

        const rowIndex = startIndex + insertOffset;

        line_item.splice(rowIndex, 0, {});
        const row = line_item[rowIndex];

        row.mercury_code = mercury;
        if (this.nav_state.context === "edit") {
            row.id = "temp";
        }

        rows.push(row); // store reference, NOT index
        insertOffset++;
    }

    /* -------------------------------
       PASS 2 â€” Call shared mercury logic safely
       ------------------------------- */
    for (const row of rows) {
        const currentIndex = line_item.indexOf(row);
        if (currentIndex === -1) continue; // row already deleted by earlier failure

        await this.handle_mercury_change(line_item, currentIndex, row.mercury_code);
    }

    /* -------------------------------
       Final error message (only once)
       ------------------------------- */
    if (this.invalidMercuries.length) {
        this.dialog.reset_to_default()
            .set_title("Some Mercury Codes Were Skipped")
            .set_message(this.invalidMercuries.join(", "))
            .set_true_action("Close")
            .show();
    }
}











async paste_mercury_from_excel(line_item, index, event) {
    this.invalidMercuries = [];
    const text = event.clipboardData.getData("text/plain");
    const copied_lines = text.trim().split(/\r?\n/);
    if (!copied_lines.length) return;

    // Step 1: Validate format first
    for (let i = 0; i < copied_lines.length; i++) {
        const mercury = copied_lines[i].split("\t")[0]?.trim();
        if (!mercury || !/^[a-zA-Z0-9]+$/.test(mercury)) {
            this.showExcelValidationError(i, "Mercury Code must be alphanumeric and not blank.");
            return;
        }
    }

    // Step 2: Process one-by-one (await works here)
    for (let lineIndex = 0; lineIndex < copied_lines.length; lineIndex++) {
        const cells = copied_lines[lineIndex].split("\t");
        const mercury_code = cells[0]?.trim() || "";

        line_item[index] = line_item[index] || {};
        line_item[index]["mercury_code"] = mercury_code;

        if (this.nav_state.context === "edit") {
            line_item[index]["id"] = "temp";
        }

        // âœ… WAIT for API validation before moving to next line
        await this.handle_mercury_change(line_item, index, mercury_code);

        if (lineIndex < copied_lines.length - 1) {
            line_item.push({});
            index++;
        }
    }
}




self.fields["promotion_category"].widget = Select(
            attrs={"class": "form-select form-select-sm"},
            choices=self.fields["promotion_category"].choices,
        )


field = self.fields["promotion_category"]

field.choices = [("", "Select Promo Category")] + [
    (value, label) for value, label in field.choices if value
]

field.widget = Select(
    attrs={"class": "form-select form-select-sm"},
    choices=field.choices,
)
field.required = True


# ---------- NSO DROPDOWN ----------
orgs = Organization.objects.exclude(
    organization_name__in=["CENV", "CEL"]
).values_list("organization_name", flat=True)

org_choices = [("", "Select NSO")] + [(org, org) for org in orgs]

self.fields["nso"].choices = org_choices
self.fields["nso"].required = True
self.fields["nso"].widget = Select(
    attrs={"class": "form-select form-select-sm"},
    choices=org_choices,
)


# ---------- PROMO CATEGORY DROPDOWN ----------
promo_choices = [("", "Select Promo Category")] + list(self.fields["promotion_category"].choices)

self.fields["promotion_category"].choices = promo_choices
self.fields["promotion_category"].required = True
self.fields["promotion_category"].widget = Select(
    attrs={"class": "form-select form-select-sm"},
    choices=promo_choices,
)





from django.forms import Select

self.fields["promotion_category"].widget = Select(
    attrs={"class": "form-select form-select-sm"},
    choices=self.fields["promotion_category"].choices,
)



{% else %}
    {% if field.field.widget.input_type == "select" or field.field.choices %}
        {{ field|add_attrs:"v-model=aif; class=form-select form-select-sm" }}
    {% else %}
        {{ field|add_attrs:"v-model=aif; class=form-control form-control-sm" }}
    {% endif %}
{% endif %}



onNSOChange(event) {
    const nso = event.target.value;
    if (!nso) return;

    this.isLoading = true;

    const url = `/api/nso-config/?nso__organization_name=${encodeURIComponent(nso)}`;

    fetch(url)
        .then(res => {
            if (!res.ok) return Promise.reject(res);
            return res.json();
        })
        .then(data => {
            const config = data[0];
            const currency = config ? config.currency : "EUR";

            this.aif.local_currency = currency;

            // âœ… Run dependent logic AFTER currency is set
            if (currency === "EUR") {
                this.aif.exchange_rate = 1;
                this.recalculateAllLines();
                this.isLoading = false;
            } else {
                // updateExchangeRate already handles recalculation + errors
                this.updateExchangeRate(true);
            }
        })
        .catch(err => {
            this.display_error(err, "Failed to load NSO configuration");
            this.isLoading = false;
        });
}







from django.db import models
from common.models import Organization


class CurrencyChoices(models.TextChoices):
    EUR = "EUR", "EUR"
    GBP = "GBP", "GBP"
    CHF = "CHF", "CHF"
    SEK = "SEK", "SEK"
    NOK = "NOK", "NOK"
    DKK = "DKK", "DKK"
    PLN = "PLN", "PLN"
    HUF = "HUF", "HUF"
    CZK = "CZK", "CZK"
    RUB = "RUB", "RUB"

class NSOConfiguration(models.Model):

    nso = models.OneToOneField(
        Organization,
        on_delete=models.CASCADE,
        related_name="config",
        limit_choices_to=~models.Q(organization_name__in=["CENV", "CEL"])
    )

    currency = models.CharField(
        max_length=3,
        choices=CurrencyChoices.choices,
        default=CurrencyChoices.EUR
    )

    operation_unit_code = models.CharField(max_length=20)

    def __str__(self):
        return f"{self.nso.organization_name} - {self.currency}"

class NSOConfigurationSerializer(serializers.ModelSerializer):
    nso_name = serializers.CharField(source="nso.organization_name", read_only=True)

    class Meta:
        model = NSOConfiguration
        fields = ["id", "nso", "nso_name", "currency", "operation_unit_code"]
# admin.py

from django.contrib import admin
from .models import NSOConfiguration

@admin.register(NSOConfiguration)
class NSOConfigurationAdmin(admin.ModelAdmin):
    list_display = ("nso", "currency", "operation_unit_code")
    list_filter = ("currency",)
    search_fields = ("nso__organization_name", "operation_unit_code")

async function loadNSOConfig() {
    const res = await fetch("/api/nso-config/");
    const data = await res.json();

    const nsoConfigMap = {};
    data.forEach(item => {
        nsoConfigMap[item.nso_name] = {
            currency: item.currency,
            operationUnit: item.operation_unit_code + " ITCG ELP On Invoice Promotion (GLB)"
        };
    });

    return nsoConfigMap;
}


# urls.py

from rest_framework.routers import DefaultRouter
from .views import NSOConfigurationViewSet

router = DefaultRouter()
router.register(r'nso-config', NSOConfigurationViewSet, basename='nso-config')

urlpatterns = router.urls


# views.py

# views.py
from rest_framework import viewsets
from .models import NSOConfiguration
from .serializers import NSOConfigurationSerializer

class NSOConfigurationViewSet(viewsets.ReadOnlyModelViewSet):
    queryset = NSOConfiguration.objects.select_related("nso")
    serializer_class = NSOConfigurationSerializer
    filterset_fields = ["nso__organization_name"]



























status_icon(status) {
  switch (status) {
    case "DRAFT":
      return `<i class="bi bi-pencil-square text-secondary"></i>`;

    case "PLANNED":
      return `<i class="bi bi-calendar-check text-primary"></i>`;

    case "AWAITING_VALIDATION":
      return `<i class="bi bi-hourglass-split text-warning"></i>`;

    case "AWAITING_APPROVAL":
      return `<i class="bi bi-hourglass-split text-warning"></i>`;

    case "COMMERCIALLY_APPROVED":
      return `<i class="bi bi-check-circle-fill text-success"></i>`;

    case "APPROVED":
      return `<i class="bi bi-check-circle-fill text-success"></i>`;

    case "INVALID":
      return `<i class="bi bi-x-circle-fill text-danger"></i>`;

    case "REJECTED":
      return `<i class="bi bi-x-circle-fill text-danger"></i>`;

    case "CLOSED":
      return `<i class="bi bi-lock-fill text-warning"></i>`;

    default:
      return `<i class="bi bi-question-circle text-muted"></i>`;
  }
}










<div v-else class="alert alert-secondary py-2 mb-0">
    <span class="text-muted fst-italic small">
        Search by {{ filter_fields.join(', ') }} â€” Select line to see available action.
    </span>
</div>



<div class="col-4">
    <label class="form-label mb-1 d-flex align-items-center gap-1">
        File Attachment
        <a :href="encodeURI('{{ site_address|safe }}{{ library }}')"
           target="_blank"
           title="File will be uploaded to SharePoint"
           class="d-inline-flex align-items-center ms-1">
            <img src="{% static 'common/img/sharepoint.svg' %}"
                 alt="SharePoint"
                 width="16"
                 height="16">
        </a>
    </label>

    <input type="file" class="form-control form-control-sm">
</div>






class OrganizationConfig(models.Model):
    organization = models.OneToOneField(
        Organization,
        on_delete=models.CASCADE,
        related_name="config"
    )
    currency = models.CharField(max_length=3)
from django.db import migrations

def create_nso_currency_mapping(apps, schema_editor):
    Organization = apps.get_model("common", "Organization")  # adjust app label
    OrganizationConfig = apps.get_model("yourapp", "OrganizationConfig")

    nso_currency_map = {
        "NSO Austria": "EUR",
        "NSO Belgium": "EUR",
        "NSO Czech": "CZK",
        "NSO Denmark": "DKK",
        "NSO Finland": "EUR",
        "NSO France": "EUR",
        "NSO Germany": "EUR",
        "NSO Hungary": "HUF",
        "NSO Ireland": "EUR",
        "NSO Italy": "EUR",
        "NSO Netherlands": "EUR",
        "NSO Norway": "NOK",
        "NSO Poland": "PLN",
        "NSO Portugal": "EUR",
        "NSO Slovakia": "EUR",
        "NSO Spain": "EUR",
        "NSO Sweden": "SEK",
        "NSO Switzerland": "CHF",
        "NSO UK": "GBP",
        "RSO Russia": "RUB",
        "CEL": "EUR",
    }

    for org_name, currency in nso_currency_map.items():
        try:
            org = Organization.objects.get(organization_name=org_name)
            OrganizationConfig.objects.update_or_create(
                organization=org,
                defaults={"currency": currency}
            )
        except Organization.DoesNotExist:
            print(f"Organization not found: {org_name}")


class Migration(migrations.Migration):

    dependencies = [
        ("yourapp", "previous_migration"),
        ("common", "organization_migration"),  # adjust if needed
    ]

    operations = [
        migrations.RunPython(create_nso_currency_mapping),
    ]
