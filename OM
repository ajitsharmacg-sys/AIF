SELECT
    CAST(ORDERED_DATE AS DATE) AS ORDERED_DATE,
    ORDER_NUMBER,
    ORDER_LINE_NUMBER_DETAIL,
    ORDERED_ITEM,
    CAST(PRICING_DATE AS DATE) AS PRICING_DATE,
    UNIT_SELLING_PRICE,
    UNIT_LIST_PRICE,
    OPERATING_NAME,
    PARTY_NUMBER
FROM [PowerBI].[dbo].[OpenOrders_AIF]
WHERE
    ORDERED_DATE >= '2026-02-02'
    AND ORDERED_DATE < DATEADD(DAY, 1, '2026-02-02');






SELECT
    CAST(ORDERED_DATE AS DATE)      AS ORDERED_DATE,
    ORDER_NUMBER,
    ORDER_LINE_NUMBER_DETAIL,
    ORDERED_ITEM,
    CAST(PRICING_DATE AS DATE)      AS PRICING_DATE,
    UNIT_SELLING_PRICE,
    UNIT_LIST_PRICE,
    OPERATING_NAME,
    PARTY_NUMBER
FROM [PowerBI].[dbo].[OpenOrders_AIF]
WHERE
    PRICING_DATE >= '2026-01-14'
    AND PRICING_DATE < DATEADD(DAY, 1, '2026-01-14')
    AND LEFT(ORDERED_ITEM, 8) IN ('4507C003', '0289C001')
    AND PARTY_NUMBER IN ('1035414');


import io
from django.db import connections
from openpyxl import Workbook


def generate_open_orders_excel(aif: Aif) -> bytes | None:
    """
    Generates Excel attachment for Open Orders based on AIF.
    Returns file bytes or None if no data found.
    """

    mercury_codes = list(
        aif.aif_lines.values_list("mercury_code", flat=True)
    )
    if not mercury_codes:
        return None

    # Customers may or may not exist
    customers = list(
        aif.aif_customer_lines.values_list("oracle_cust_number", flat=True)
    )

    start_date = aif.start_date

    # ðŸ”¹ Build SQL dynamically
    sql = """
        SELECT
            ORDERED_DATE,
            ORDER_NUMBER,
            ORDER_LINE_NUMBER_DETAIL,
            ORDERED_ITEM,
            PRICING_DATE,
            UNIT_SELLING_PRICE,
            UNIT_LIST_PRICE,
            OPERATING_NAME,
            PARTY_NUMBER
        FROM [PowerBI].[dbo].[OpenOrders_AIF]
        WHERE
            PRICING_DATE >= %s
            AND LEFT(ORDERED_ITEM, 8) IN %s
    """

    params = [start_date, tuple(mercury_codes)]

    if customers:
        sql += " AND PARTY_NUMBER IN %s"
        params.append(tuple(customers))

    # ðŸ”¹ Execute query
    with connections["powerbi"].cursor() as cursor:
        cursor.execute(sql, params)
        rows = cursor.fetchall()
        columns = [col[0] for col in cursor.description]

    if not rows:
        return None

    # ðŸ”¹ Create Excel in memory
    wb = Workbook()
    ws = wb.active
    ws.title = "Open Orders"

    ws.append(columns)
    for row in rows:
        ws.append(row)

    buffer = io.BytesIO()
    wb.save(buffer)
    buffer.seek(0)

    return buffer.read()


attachments = []

excel_bytes = generate_open_orders_excel(aif)
if excel_bytes:
    attachments.append(
        (f"{aif.aif_id}_impacted_orders.xlsx", excel_bytes)
    )

if attachments:
    send_email_with_attachments(...)
else:
    send_email_to_group(...)
