class OMEmailsConfig(models.Model):
    om_emails = models.TextField(
        max_length=1000,
        null=True,
        blank=True,
        verbose_name="OM Emails"
    )

    def get_email_list(self):
        if not self.om_emails:
            return []

        return [
            email.strip()
            for email in self.om_emails.split(";")
            if email.strip()
        ]

    def __str__(self):
        return f"{self.om_emails}"

    class Meta:
        verbose_name_plural = "OM Emails Config"


pandas==3.0.0
openpyxl==3.1.5

from io import BytesIO
from django.db import connection
from django.utils import timezone
import pandas as pd


def prepare_open_orders_attachment(self, aif):

    mercury_codes = list(
        aif.aif_lines.values_list("mercury_code", flat=True)
    )

    if not mercury_codes:
        return None

    customers = list(
        aif.aif_customer_lines.values_list("oracle_cust_number", flat=True)
    )

    pricing_date = aif.start_date

    sql = """
        SELECT
            CAST(ORDERED_DATE AS DATE) AS ORDERED_DATE,
            ORDER_NUMBER,
            ORDER_LINE_NUMBER_DETAIL,
            ORDERED_ITEM,
            CAST(PRICING_DATE AS DATE) AS PRICING_DATE,
            UNIT_SELLING_PRICE,
            UNIT_LIST_PRICE,
            OPERATING_NAME,
            PARTY_NUMBER
        FROM [PowerBI].[dbo].[OpenOrders_AIF]
        WHERE
            CAST(PRICING_DATE AS DATE) = %s
            AND LEFT(ORDERED_ITEM, 8) IN %s
    """

    params = [pricing_date, tuple(mercury_codes)]

    if customers:
        sql += " AND PARTY_NUMBER IN %s"
        params.append(tuple(customers))

    # ðŸ”¹ Use pandas to fetch data
    df = pd.read_sql(sql, connection, params=params)

    if df.empty:
        return None

    # ðŸ”¹ Format headers (replace _ with space + Title case)
    df.columns = df.columns.str.replace("_", " ").str.title()

    # =========================
    # Write Excel in memory
    # =========================
    buffer = BytesIO()

    with pd.ExcelWriter(
        buffer,
        engine="openpyxl"
    ) as writer:

        df.to_excel(
            writer,
            sheet_name="Open Orders",
            index=False
        )

        workbook = writer.book
        worksheet = writer.sheets["Open Orders"]

        # ðŸ”¹ Bold header
        from openpyxl.styles import Font
        for cell in worksheet[1]:
            cell.font = Font(bold=True)

        # ðŸ”¹ Auto column width
        for column in worksheet.columns:
            max_length = 0
            column_letter = column[0].column_letter

            for cell in column:
                if cell.value:
                    max_length = max(max_length, len(str(cell.value)))

            worksheet.column_dimensions[column_letter].width = max_length + 2

        # ðŸ”¹ Freeze header row
        worksheet.freeze_panes = "A2"

    buffer.seek(0)

    filename = (
        f"OpenOrders_AIF_{aif.aif_id}_"
        f"{timezone.now().strftime('%Y%m%d_%H%M')}.xlsx"
    )

    return {
        "file_name": filename,
        "file_content": buffer.getvalue(),
        "mime_type": "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
    }









from io import BytesIO
from django.db import connection
from openpyxl import Workbook


def generate_open_orders_attachment(self, aif):

    mercury_codes = list(
        aif.aif_lines.values_list("mercury_code", flat=True)
    )

    if not mercury_codes:
        return None

    customers = list(
        aif.aif_customer_lines.values_list("oracle_cust_number", flat=True)
    )

    pricing_date = aif.start_date  # DateField â†’ already date only

    sql = """
        SELECT
            CAST(ORDERED_DATE AS DATE) AS ORDERED_DATE,
            ORDER_NUMBER,
            ORDER_LINE_NUMBER_DETAIL,
            ORDERED_ITEM,
            CAST(PRICING_DATE AS DATE) AS PRICING_DATE,
            UNIT_SELLING_PRICE,
            UNIT_LIST_PRICE,
            OPERATING_NAME,
            PARTY_NUMBER
        FROM [PowerBI].[dbo].[OpenOrders_AIF]
        WHERE
            CAST(PRICING_DATE AS DATE) = %s
            AND LEFT(ORDERED_ITEM, 8) IN %s
    """

    params = [pricing_date, tuple(mercury_codes)]

    if customers:
        sql += " AND PARTY_NUMBER IN %s"
        params.append(tuple(customers))

    with connection.cursor() as cursor:
        cursor.execute(sql, params)
        rows = cursor.fetchall()
        columns = [col[0] for col in cursor.description]

    if not rows:
        return None

    # ðŸŸ¢ Create workbook in memory
    wb = Workbook()
    ws = wb.active
    ws.title = "Open Orders"

    ws.append(columns)

    for row in rows:
        ws.append(row)

    # ðŸŸ¢ Save into memory buffer
    buffer = BytesIO()
    wb.save(buffer)
    buffer.seek(0)

    return buffer

from django.core.mail import EmailMessage
from django.utils import timezone


def send_notification_with_attachment(self, aif):

    excel_buffer = self.generate_open_orders_attachment(aif)

    subject = f"AIF {aif.aif_id} - Open Orders Report"
    body = "Please find the attached Open Orders report."

    recipients = [aif.meta_created_by.email]  # adjust as needed

    email = EmailMessage(
        subject=subject,
        body=body,
        to=recipients
    )

    if excel_buffer:
        filename = f"OpenOrders_AIF_{aif.aif_id}_{timezone.now().strftime('%Y%m%d_%H%M')}.xlsx"

        email.attach(
            filename,
            excel_buffer.getvalue(),
            "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
        )

    email.send()













FORMAT(ORDERED_DATE, 'dd-MM-yyyy HH-mm') AS ORDERED_DATE

SELECT
    CAST(ORDERED_DATE AS DATE) AS ORDERED_DATE,
    ORDER_NUMBER,
    ORDER_LINE_NUMBER_DETAIL,
    ORDERED_ITEM,
    CAST(PRICING_DATE AS DATE) AS PRICING_DATE,
    UNIT_SELLING_PRICE,
    UNIT_LIST_PRICE,
    OPERATING_NAME,
    PARTY_NUMBER
FROM [PowerBI].[dbo].[OpenOrders_AIF]
WHERE
    CAST(PRICING_DATE AS DATE) = '2026-02-02'
    AND LEFT(ORDERED_ITEM, 8) IN ('4507C003', '0289C001')
    AND PARTY_NUMBER IN ('1035414', '1056789');

import io
from django.db import connections
from openpyxl import Workbook


def generate_open_orders_excel(aif: Aif) -> bytes | None:
    """
    Generates Excel attachment for Open Orders based on AIF.
    Returns file bytes or None if no data found.
    """

    mercury_codes = list(
        aif.aif_lines.values_list("mercury_code", flat=True)
    )
    if not mercury_codes:
        return None

    # Customers may or may not exist
    customers = list(
        aif.aif_customer_lines.values_list("oracle_cust_number", flat=True)
    )

    start_date = aif.start_date

    # ðŸ”¹ Build SQL dynamically
    sql = """
        SELECT
            ORDERED_DATE,
            ORDER_NUMBER,
            ORDER_LINE_NUMBER_DETAIL,
            ORDERED_ITEM,
            PRICING_DATE,
            UNIT_SELLING_PRICE,
            UNIT_LIST_PRICE,
            OPERATING_NAME,
            PARTY_NUMBER
        FROM [PowerBI].[dbo].[OpenOrders_AIF]
        WHERE
            PRICING_DATE >= %s
            AND LEFT(ORDERED_ITEM, 8) IN %s
    """

    params = [start_date, tuple(mercury_codes)]

    if customers:
        sql += " AND PARTY_NUMBER IN %s"
        params.append(tuple(customers))

    # ðŸ”¹ Execute query
    with connections["powerbi"].cursor() as cursor:
        cursor.execute(sql, params)
        rows = cursor.fetchall()
        columns = [col[0] for col in cursor.description]

    if not rows:
        return None

    # ðŸ”¹ Create Excel in memory
    wb = Workbook()
    ws = wb.active
    ws.title = "Open Orders"

    ws.append(columns)
    for row in rows:
        ws.append(row)

    buffer = io.BytesIO()
    wb.save(buffer)
    buffer.seek(0)

    return buffer.read()


attachments = []

excel_bytes = generate_open_orders_excel(aif)
if excel_bytes:
    attachments.append(
        (f"{aif.aif_id}_impacted_orders.xlsx", excel_bytes)
    )

if attachments:
    send_email_with_attachments(...)
else:
    send_email_to_group(...)
