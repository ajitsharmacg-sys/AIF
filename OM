if new_status == AifStatusChoices.AWAITING_VALIDATION:
    attachment = prepare_open_orders_attachment(aif)
    email_config = OMEmailsConfig.objects.filter(nso=aif.nso).first()

    email_body = build_om_email_body(aif)

    if email_config and email_config.om_emails and attachment:
        send_email_with_attachments(
            to=email_config.om_emails,
            subject=f"AIF {aif.aif_id} - Open Orders Report",
            body=email_body,
            cc=None,
            attachments=[attachment],
        )

def build_om_email_body(aif: Aif) -> str:
    customers_html = ""
    if aif.aif_customer_lines.exists():
        for cust in aif.aif_customer_lines.all():
            customers_html += f"""
                <tr>
                    <td>{cust.oracle_cust_number}</td>
                    <td>{cust.oracle_cust_name or ''}</td>
                </tr>
            """
    else:
        customers_html = """
            <tr>
                <td colspan="2" style="text-align:center;">
                    All customers for selected NSO
                </td>
            </tr>
        """

    lines_html = ""
    for line in aif.aif_lines.all():
        lines_html += f"""
            <tr>
                <td>{line.product_group or ''}</td>
                <td>{line.mercury_code}</td>
                <td>{line.product_description or ''}</td>
                <td>{line.elp_eur}</td>
                <td>{line.elp}</td>
                <td>{line.promotional_elp}</td>
            </tr>
        """

    return f"""
    <div style="font-family: Arial, sans-serif; font-size: 14px;">

        <p>Dear OM Team,</p>

        <p>
            Please be advised the ONINVOICE promotion request has been implemented in Oracle.
        </p>

        <hr>

        <h4>AIF Information</h4>
        <p><strong>AIF Reference:</strong> {aif.aif_id}</p>
        <p><strong>NSO:</strong> {aif.nso}</p>
        <p><strong>Promotion Category:</strong> {aif.promotion_category}</p>

        <br>

        <h4>Promotion Period</h4>
        <table border="1" cellpadding="6" cellspacing="0" width="50%">
            <tr>
                <th align="left">Start Date</th>
                <td>{aif.start_date}</td>
            </tr>
            <tr>
                <th align="left">End Date</th>
                <td>{aif.end_date}</td>
            </tr>
        </table>

        <br>

        <h4>Customer Details</h4>
        <table border="1" cellpadding="6" cellspacing="0" width="100%">
            <tr>
                <th>Customer No</th>
                <th>Customer Name</th>
            </tr>
            {customers_html}
        </table>

        <br>

        <h4>Product Details</h4>
        <table border="1" cellpadding="6" cellspacing="0" width="100%">
            <tr>
                <th>Product Group</th>
                <th>Mercury Code</th>
                <th>Product Description</th>
                <th>ELP (EUR)</th>
                <th>Local ELP</th>
                <th>Promo ELP</th>
            </tr>
            {lines_html}
        </table>

        <br>

        <p>
            Kindly review the attached document for the list of impacted orders.
        </p>

        <br>

        <p>
            Thanks,<br>
            Kind Regards,<br>
            <strong>Rev Sales Ops Team</strong>
        </p>

    </div>
    """



if new_status == AifStatusChoices.AWAITING_VALIDATION:
    attachment = prepare_open_orders_attachment(aif)

    email_config = OMEmailsConfig.objects.filter(
        nso=aif.nso
    ).first()

    email_body = f"""
        Dear OM Team,<br><br>

        Please be advised the ONINVOICE promotion request
        has been implemented in Oracle.<br><br>

        Kindly review the attached document for the list of
        impacted orders.<br><br>

        If an order was booked prior to the implementation date of the AIF,
        please refresh the order accordingly.<br><br>

        Note:Please view attachment for the orders details.<br><br>

        Thanks,<br>
        Kind Regards<br>
        Rev Sales Ops Team
    """

    if email_config and email_config.om_emails and attachment:

        send_email_with_attachments(
            to=email_config.om_emails,
            subject=f"AIF {aif.aif_id} - Open Orders Report",
            body=email_body,
            cc=None,
            attachments=[attachment],
        )







canSelectAnyLine() {
  if (!this.selected_aif?.aif_lines?.length) return false;

  if (this.user_role.includes(this.admin_role)) {
    return true;
  }

  return this.selected_aif.aif_lines.some(line =>
    this.get_line_status(line)?.status === "AWAITING_APPROVAL" &&
    this.canActOnLine(line)
  );
}
<input
    id="select_all_lines_checkbox"
    title="Select all"
    class="form-check-input border-secondary"
    type="checkbox"
    :disabled="!canSelectAnyLine"
    @click="select_all_lines($event)"
/>









def prepare_open_orders_attachment(aif):
    mercury_codes = list(aif.aif_lines.values_list("mercury_code", flat=True))
    if not mercury_codes:
        return None

    customers = list(
        aif.aif_customer_lines.values_list("oracle_cust_number", flat=True)
    )

    pricing_date = aif.start_date
    mercury_placeholders = ",".join(["%s"] * len(mercury_codes))

    sql = f"""
        SELECT
            OPERATING_NAME,
            CAST(ORDERED_DATE AS DATE) AS ORDERED_DATE,
            ORDER_NUMBER,
            ORDER_LINE_NUMBER_DETAIL,
            PARTY_NUMBER,
            ORDERED_ITEM,
            CAST(PRICING_DATE AS DATE) AS PRICING_DATE,
            UNIT_LIST_PRICE,
            UNIT_SELLING_PRICE
        FROM dbo.OpenOrders_AIF
        WHERE
            CAST(PRICING_DATE AS DATE) = %s
            AND LEFT(ORDERED_ITEM, 8) IN ({mercury_placeholders})
    """

    params = [pricing_date] + mercury_codes

    if customers:
        customer_placeholders = ",".join(["%s"] * len(customers))
        sql += f" AND PARTY_NUMBER IN ({customer_placeholders})"
        params += customers

    with connections["powerbi"].cursor() as cursor:
        cursor.execute(sql, params)
        columns = [col[0] for col in cursor.description]
        rows = cursor.fetchall()

    if not rows:
        return None

    wb = Workbook()
    ws = wb.active
    ws.title = "Open Orders"

    headers = [col.replace("_", " ").title() for col in columns]
    ws.append(headers)

    for cell in ws[1]:
        cell.font = Font(bold=True)

    for col_index, header in enumerate(headers, start=1):
        column_letter = get_column_letter(col_index)
        ws.column_dimensions[column_letter].width = len(header) + 4

    for row in rows:
        ws.append(row)

    ws.freeze_panes = "A2"

    buffer = BytesIO()
    wb.save(buffer)
    buffer.seek(0)

    encoded_file = base64.b64encode(buffer.getvalue()).decode("utf-8")

    filename = (
        f"OpenOrders_AIF_{aif.aif_id}_"
        f"{timezone.now().strftime('%Y%m%d_%H%M')}.xlsx"
    )

    return {
        "Name": filename,
        "ContentBytes": encoded_file,
    }



@admin.register(OMEmailsConfig)
class OMEmailsConfigAdmin(admin.ModelAdmin):
    save_as = False
    form = OMEmailsConfigForm

    list_display = (
        "id",
        "om_emails",
    )

    def has_add_permission(self, request):
        # Only admin role users
        if not request.user.groups.filter(name=ADMIN_ROLE).exists():
            return False

        # Allow add only if no object exists
        if OMEmailsConfig.objects.exists():
            return False

        return True

    def has_change_permission(self, request, obj=None):
        return request.user.groups.filter(name=ADMIN_ROLE).exists()

    def has_delete_permission(self, request, obj=None):
        return request.user.groups.filter(name=ADMIN_ROLE).exists()

<section class="section" id="aif_app">
    <div v-if="nav_state.aif_app">

        <!-- âœ… GLOBAL LOADER HERE -->
        <div v-if="isLoading"
             class="position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center bg-white bg-opacity-75"
             style="z-index: 1055;">
            <div class="text-center">
                <div class="spinner-border text-primary" role="status"></div>
                <div class="small mt-2 text-muted">Processing...</div>
            </div>
        </div>

        <!-- Existing content continues -->
        <div class="fs-4 mb-3">
            ...


async paste_customer_from_excel(line_item, index, event) {
    this.isLoading = true;

    const text = event.clipboardData.getData("text/plain");
    const copied_lines = text.trim().split(/\r?\n/);

    if (!copied_lines.length) {
        this.isLoading = false;
        return;
    }

    // Step 1: Validate format only
    for (let i = 0; i < copied_lines.length; i++) {
        const customer = copied_lines[i].split("\t")[0]?.trim();

        if (!customer || !/^[a-zA-Z0-9]+$/.test(customer)) {
            this.showExcelValidationError(
                i,
                "Customer Number must be alphanumeric and not blank."
            );
            this.isLoading = false;
            return;
        }
    }

    const rowRefs = [];

    // Step 2: Insert rows first (same pattern as mercury)
    for (let i = 0; i < copied_lines.length; i++) {

        const customer_number = copied_lines[i].split("\t")[0].trim();

        let row;

        if (i === 0 && !line_item[index]?.oracle_cust_number) {
            row = line_item[index];
        } else {
            line_item.splice(index, 0, {});
            row = line_item[index];
        }

        row.oracle_cust_number = customer_number;

        if (this.nav_state.context === "edit") {
            row.id = "temp";
        }

        rowRefs.push(row);
        index++;
    }

    // Step 3: Validate each row against DB
    for (const row of rowRefs) {

        const currentIndex = line_item.indexOf(row);
        if (currentIndex === -1) continue;

        await this.handle_customer_change(
            line_item,
            currentIndex,
            row.oracle_cust_number
        );
    }

    this.isLoading = false;
}







updateExchangeRate(recalculate = false) {
    if (!this.aif.local_currency) return;

    this.isLoading = true;

    const url = `${api_endpoints.exchange_rates}?to_currency=${encodeURIComponent(this.aif.local_currency)}`;

    fetch(url)
        .then(res => {
            if (!res.ok) return Promise.reject(res);
            return res.json();
        })
        .then(data => {

            // ðŸ”´ NEW: Handle empty response
            if (!data || data.length === 0) {
                this.isLoading = false;

                this.aif.exchange_rate = "";

                this.dialog
                    .reset_to_default()
                    .set_title("Exchange Rate Not Found")
                    .set_message(`No exchange rate found for currency ${this.aif.local_currency}. Please contact Admin.`)
                    .set_true_action("Close")
                    .show();

                return;  // â›” Stop execution
            }

            const rate = parseFloat(data[0].conversion_rate);

            if (isNaN(rate)) {
                this.isLoading = false;

                this.dialog
                    .reset_to_default()
                    .set_title("Invalid Exchange Rate")
                    .set_message("Exchange rate value is invalid. Please contact Admin.")
                    .set_true_action("Close")
                    .show();

                return;
            }

            this.aif.exchange_rate = rate.toFixed(2);

            if (recalculate) {
                this.recalculateAllLines();
            }

            this.isLoading = false;
        })
        .catch(err => {
            this.display_error(err, "Failed to load exchange rate");
            this.isLoading = false;
        });
},





onNSOChange(event) {
    const nso = event.target.value;
    if (!nso) return;

    this.isLoading = true;

    const url = api_endpoints.nso_currency_opunit + "?nso=" + encodeURIComponent(nso);

    fetch(url)
        .then(res => {
            if (!res.ok) return Promise.reject(res);
            return res.json();
        })
        .then(data => {

            // ðŸ”´ NEW: If empty response
            if (!data || data.length === 0) {
                this.isLoading = false;

                this.aif.local_currency = "";
                this.aif.exchange_rate = "";

                this.dialog
                    .reset_to_default()
                    .set_title("Configuration Missing")
                    .set_message(`No NSO Currency / Operating Unit configuration found for ${nso}. Please contact Admin.`)
                    .set_true_action("Close")
                    .show();

                return;  // â›” Stop execution
            }

            const config = data[0];
            const currency = config.currency;

            this.aif.local_currency = currency;

            if (currency === "EUR") {
                this.aif.exchange_rate = 1;
                this.recalculateAllLines();
                this.isLoading = false;
            } else {
                this.updateExchangeRate(true);
            }
        })
        .catch(err => {
            this.display_error(err, "Failed to load NSO configuration");
            this.isLoading = false;
        });
},


from openpyxl.utils import get_column_letter

def prepare_open_orders_attachment(aif):
    mercury_codes = list(
        aif.aif_lines.values_list("mercury_code", flat=True)
    )

    if not mercury_codes:
        return None

    customers = list(
        aif.aif_customer_lines.values_list("oracle_cust_number", flat=True)
    )

    pricing_date = aif.start_date

    mercury_placeholders = ",".join(["%s"] * len(mercury_codes))

    sql = f"""
        SELECT
            CAST(ORDERED_DATE AS DATE) AS ORDERED_DATE,
            ORDER_NUMBER,
            ORDER_LINE_NUMBER_DETAIL,
            ORDERED_ITEM,
            CAST(PRICING_DATE AS DATE) AS PRICING_DATE,
            UNIT_SELLING_PRICE,
            UNIT_LIST_PRICE,
            OPERATING_NAME,
            PARTY_NUMBER
        FROM dbo.OpenOrders_AIF
        WHERE
            CAST(PRICING_DATE AS DATE) = %s
            AND LEFT(ORDERED_ITEM, 8) IN ({mercury_placeholders})
    """

    params = [pricing_date] + mercury_codes

    if customers:
        customer_placeholders = ",".join(["%s"] * len(customers))
        sql += f" AND PARTY_NUMBER IN ({customer_placeholders})"
        params += customers

    with connections["powerbi"].cursor() as cursor:
        cursor.execute(sql, params)
        columns = [col[0] for col in cursor.description]
        rows = cursor.fetchall()

    if not rows:
        return None

    wb = Workbook()
    ws = wb.active
    ws.title = "Open Orders"

    # Format headers
    headers = [col.replace("_", " ").title() for col in columns]
    ws.append(headers)

    # Bold header
    for cell in ws[1]:
        cell.font = Font(bold=True)

    # âœ… Set column width ONLY based on header length
    for col_index, header in enumerate(headers, start=1):
        column_letter = get_column_letter(col_index)
        ws.column_dimensions[column_letter].width = len(header) + 4

    # Add data rows
    for row in rows:
        ws.append(row)

    ws.freeze_panes = "A2"

    buffer = BytesIO()
    wb.save(buffer)
    buffer.seek(0)

    encoded_file = base64.b64encode(buffer.getvalue()).decode("utf-8")

    filename = (
        f"OpenOrders_AIF_{aif.aif_id}_"
        f"{timezone.now().strftime('%Y%m%d_%H%M')}.xlsx"
    )

    return {
        "Name": filename,
        "ContentBytes": encoded_file,
    }

import base64
from io import BytesIO
from openpyxl import Workbook
from openpyxl.styles import Font
from django.utils import timezone
from django.db import connections


def prepare_open_orders_attachment(aif):
    mercury_codes = list(
        aif.aif_lines.values_list("mercury_code", flat=True)
    )

    if not mercury_codes:
        return None

    customers = list(
        aif.aif_customer_lines.values_list("oracle_cust_number", flat=True)
    )

    pricing_date = aif.start_date

    mercury_placeholders = ",".join(["%s"] * len(mercury_codes))

    sql = f"""
        SELECT
            CAST(ORDERED_DATE AS DATE) AS ORDERED_DATE,
            ORDER_NUMBER,
            ORDER_LINE_NUMBER_DETAIL,
            ORDERED_ITEM,
            CAST(PRICING_DATE AS DATE) AS PRICING_DATE,
            UNIT_SELLING_PRICE,
            UNIT_LIST_PRICE,
            OPERATING_NAME,
            PARTY_NUMBER
        FROM dbo.OpenOrders_AIF
        WHERE
            CAST(PRICING_DATE AS DATE) = %s
            AND LEFT(ORDERED_ITEM, 8) IN ({mercury_placeholders})
    """

    params = [pricing_date] + mercury_codes

    if customers:
        customer_placeholders = ",".join(["%s"] * len(customers))
        sql += f" AND PARTY_NUMBER IN ({customer_placeholders})"
        params += customers

    with connections["powerbi"].cursor() as cursor:
        cursor.execute(sql, params)
        columns = [col[0] for col in cursor.description]
        rows = cursor.fetchall()

    if not rows:
        return None

    wb = Workbook()
    ws = wb.active
    ws.title = "Open Orders"

    headers = [col.replace("_", " ").title() for col in columns]
    ws.append(headers)

    for cell in ws[1]:
        cell.font = Font(bold=True)

    for row in rows:
        ws.append(row)

    ws.freeze_panes = "A2"

    buffer = BytesIO()
    wb.save(buffer)
    buffer.seek(0)

    file_bytes = buffer.getvalue()
    encoded_file = base64.b64encode(file_bytes).decode("utf-8")

    filename = (
        f"OpenOrders_AIF_{aif.aif_id}_"
        f"{timezone.now().strftime('%Y%m%d_%H%M')}.xlsx"
    )

    # ðŸ”¥ IMPORTANT: match Azure expected structure
    return {
        "Name": filename,
        "ContentBytes": encoded_file,
    }














from django.db import connections
from django.utils import timezone
from io import BytesIO
from openpyxl import Workbook
from openpyxl.styles import Font


def prepare_open_orders_attachment(aif):
    mercury_codes = list(
        aif.aif_lines.values_list("mercury_code", flat=True)
    )

    if not mercury_codes:
        return None

    customers = list(
        aif.aif_customer_lines.values_list("oracle_cust_number", flat=True)
    )

    pricing_date = aif.start_date  # DateField (DATE only)

    # Dynamic placeholders
    mercury_placeholders = ",".join(["%s"] * len(mercury_codes))

    sql = f"""
        SELECT
            CAST(ORDERED_DATE AS DATE) AS ORDERED_DATE,
            ORDER_NUMBER,
            ORDER_LINE_NUMBER_DETAIL,
            ORDERED_ITEM,
            CAST(PRICING_DATE AS DATE) AS PRICING_DATE,
            UNIT_SELLING_PRICE,
            UNIT_LIST_PRICE,
            OPERATING_NAME,
            PARTY_NUMBER
        FROM dbo.OpenOrders_AIF
        WHERE
            CAST(PRICING_DATE AS DATE) = %s
            AND LEFT(ORDERED_ITEM, 8) IN ({mercury_placeholders})
    """

    params = [pricing_date] + mercury_codes

    if customers:
        customer_placeholders = ",".join(["%s"] * len(customers))
        sql += f" AND PARTY_NUMBER IN ({customer_placeholders})"
        params += customers

    # Execute query
    with connections["powerbi"].cursor() as cursor:
        cursor.execute(sql, params)
        columns = [col[0] for col in cursor.description]
        rows = cursor.fetchall()

    if not rows:
        return None

    # Create Excel workbook
    wb = Workbook()
    ws = wb.active
    ws.title = "Open Orders"

    # Format headers (replace _ with space)
    formatted_headers = [col.replace("_", " ").title() for col in columns]
    ws.append(formatted_headers)

    # Bold header row
    for cell in ws[1]:
        cell.font = Font(bold=True)

    # Add data rows
    for row in rows:
        ws.append(row)

    # Auto column width
    for column in ws.columns:
        max_length = 0
        column_letter = column[0].column_letter

        for cell in column:
            if cell.value:
                max_length = max(max_length, len(str(cell.value)))

        ws.column_dimensions[column_letter].width = max_length + 2

    ws.freeze_panes = "A2"

    # Save to memory
    buffer = BytesIO()
    wb.save(buffer)
    buffer.seek(0)

    filename = (
        f"OpenOrders_AIF_{aif.aif_id}_"
        f"{timezone.now().strftime('%Y%m%d_%H%M')}.xlsx"
    )

    return {
        "file_name": filename,
        "file_content": buffer.getvalue(),
        "mime_type": "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
    }














from django.db import connections
from io import BytesIO
from django.utils import timezone
from openpyxl.styles import Font
import pandas as pd


def prepare_open_orders_attachment(aif):
    mercury_codes = list(
        aif.aif_lines.values_list("mercury_code", flat=True)
    )

    if not mercury_codes:
        return None

    customers = list(
        aif.aif_customer_lines.values_list("oracle_cust_number", flat=True)
    )

    pricing_date = aif.start_date  # DateField â†’ already DATE only

    # Build dynamic placeholders for IN clause
    mercury_placeholders = ",".join(["%s"] * len(mercury_codes))

    sql = f"""
        SELECT
            CAST(ORDERED_DATE AS DATE) AS ORDERED_DATE,
            ORDER_NUMBER,
            ORDER_LINE_NUMBER_DETAIL,
            ORDERED_ITEM,
            CAST(PRICING_DATE AS DATE) AS PRICING_DATE,
            UNIT_SELLING_PRICE,
            UNIT_LIST_PRICE,
            OPERATING_NAME,
            PARTY_NUMBER
        FROM dbo.OpenOrders_AIF
        WHERE
            CAST(PRICING_DATE AS DATE) = %s
            AND LEFT(ORDERED_ITEM, 8) IN ({mercury_placeholders})
    """

    params = [pricing_date] + mercury_codes

    if customers:
        customer_placeholders = ",".join(["%s"] * len(customers))
        sql += f" AND PARTY_NUMBER IN ({customer_placeholders})"
        params += customers

    # Use PowerBI database connection
    df = pd.read_sql(sql, connections["powerbi"].connection, params=params)

    if df.empty:
        return None

    # Format column headers (replace _ with space)
    df.columns = df.columns.str.replace("_", " ").str.title()

    # Write Excel in memory
    buffer = BytesIO()

    with pd.ExcelWriter(buffer, engine="openpyxl") as writer:
        df.to_excel(writer, sheet_name="Open Orders", index=False)

        workbook = writer.book
        worksheet = writer.sheets["Open Orders"]

        # Bold header row
        for cell in worksheet[1]:
            cell.font = Font(bold=True)

        # Auto column width
        for column in worksheet.columns:
            max_length = 0
            column_letter = column[0].column_letter

            for cell in column:
                if cell.value:
                    max_length = max(max_length, len(str(cell.value)))

            worksheet.column_dimensions[column_letter].width = max_length + 2

        worksheet.freeze_panes = "A2"

    buffer.seek(0)

    filename = (
        f"OpenOrders_AIF_{aif.aif_id}_"
        f"{timezone.now().strftime('%Y%m%d_%H%M')}.xlsx"
    )

    return {
        "file_name": filename,
        "file_content": buffer.getvalue(),
        "mime_type": "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
    }











if new_status == AifStatusChoices.AWAITING_VALIDATION:

    attachment = prepare_open_orders_attachment(aif)
    email_config = OMEmailsConfig.objects.first()

    if (
        email_config
        and email_config.om_emails
        and attachment
        and attachment.get("file_content")
    ):
        send_email_with_attachments(
            to=email_config.om_emails,
            subject=f"AIF {aif.aif_id} - Open Orders Report",
            body="Please find the attached Open Orders report.",
            cc=None,
            attachments=[attachment],
        )




from django.db import models
from django.core.validators import validate_email
from django.core.exceptions import ValidationError


class OMEmailsConfig(models.Model):
    om_emails = models.TextField(
        max_length=1000,
        null=True,
        blank=True,
        verbose_name="OM Emails"
    )

    def clean(self):
        if not self.om_emails:
            return

        emails = [email.strip() for email in self.om_emails.split(";") if email.strip()]

        invalid_emails = []

        for email in emails:
            try:
                validate_email(email)
            except ValidationError:
                invalid_emails.append(email)

        if invalid_emails:
            raise ValidationError(
                {
                    "om_emails": f"Invalid email(s): {', '.join(invalid_emails)}"
                }
            )

    def __str__(self):
        return self.om_emails or ""

    class Meta:
        verbose_name_plural = "OM Emails Config"


@admin.register(OMEmailsConfig)
class OMEmailsConfigAdmin(admin.ModelAdmin):
    form = OMEmailsConfigForm


config = OMEmailsConfig.objects.first()
om_emails = config.get_email_list() if config else []

class OMEmailsConfig(models.Model):
    om_emails = models.TextField(
        max_length=1000,
        null=True,
        blank=True,
        verbose_name="OM Emails"
    )

    def get_email_list(self):
        if not self.om_emails:
            return []

        return [
            email.strip()
            for email in self.om_emails.split(";")
            if email.strip()
        ]

    def __str__(self):
        return f"{self.om_emails}"

    class Meta:
        verbose_name_plural = "OM Emails Config"


pandas==3.0.0
openpyxl==3.1.5

from io import BytesIO
from django.db import connection
from django.utils import timezone
import pandas as pd


def prepare_open_orders_attachment(self, aif):

    mercury_codes = list(
        aif.aif_lines.values_list("mercury_code", flat=True)
    )

    if not mercury_codes:
        return None

    customers = list(
        aif.aif_customer_lines.values_list("oracle_cust_number", flat=True)
    )

    pricing_date = aif.start_date

    sql = """
        SELECT
            CAST(ORDERED_DATE AS DATE) AS ORDERED_DATE,
            ORDER_NUMBER,
            ORDER_LINE_NUMBER_DETAIL,
            ORDERED_ITEM,
            CAST(PRICING_DATE AS DATE) AS PRICING_DATE,
            UNIT_SELLING_PRICE,
            UNIT_LIST_PRICE,
            OPERATING_NAME,
            PARTY_NUMBER
        FROM [PowerBI].[dbo].[OpenOrders_AIF]
        WHERE
            CAST(PRICING_DATE AS DATE) = %s
            AND LEFT(ORDERED_ITEM, 8) IN %s
    """

    params = [pricing_date, tuple(mercury_codes)]

    if customers:
        sql += " AND PARTY_NUMBER IN %s"
        params.append(tuple(customers))

    # ðŸ”¹ Use pandas to fetch data
    df = pd.read_sql(sql, connection, params=params)

    if df.empty:
        return None

    # ðŸ”¹ Format headers (replace _ with space + Title case)
    df.columns = df.columns.str.replace("_", " ").str.title()

    # =========================
    # Write Excel in memory
    # =========================
    buffer = BytesIO()

    with pd.ExcelWriter(
        buffer,
        engine="openpyxl"
    ) as writer:

        df.to_excel(
            writer,
            sheet_name="Open Orders",
            index=False
        )

        workbook = writer.book
        worksheet = writer.sheets["Open Orders"]

        # ðŸ”¹ Bold header
        from openpyxl.styles import Font
        for cell in worksheet[1]:
            cell.font = Font(bold=True)

        # ðŸ”¹ Auto column width
        for column in worksheet.columns:
            max_length = 0
            column_letter = column[0].column_letter

            for cell in column:
                if cell.value:
                    max_length = max(max_length, len(str(cell.value)))

            worksheet.column_dimensions[column_letter].width = max_length + 2

        # ðŸ”¹ Freeze header row
        worksheet.freeze_panes = "A2"

    buffer.seek(0)

    filename = (
        f"OpenOrders_AIF_{aif.aif_id}_"
        f"{timezone.now().strftime('%Y%m%d_%H%M')}.xlsx"
    )

    return {
        "file_name": filename,
        "file_content": buffer.getvalue(),
        "mime_type": "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
    }









from io import BytesIO
from django.db import connection
from openpyxl import Workbook


def generate_open_orders_attachment(self, aif):

    mercury_codes = list(
        aif.aif_lines.values_list("mercury_code", flat=True)
    )

    if not mercury_codes:
        return None

    customers = list(
        aif.aif_customer_lines.values_list("oracle_cust_number", flat=True)
    )

    pricing_date = aif.start_date  # DateField â†’ already date only

    sql = """
        SELECT
            CAST(ORDERED_DATE AS DATE) AS ORDERED_DATE,
            ORDER_NUMBER,
            ORDER_LINE_NUMBER_DETAIL,
            ORDERED_ITEM,
            CAST(PRICING_DATE AS DATE) AS PRICING_DATE,
            UNIT_SELLING_PRICE,
            UNIT_LIST_PRICE,
            OPERATING_NAME,
            PARTY_NUMBER
        FROM [PowerBI].[dbo].[OpenOrders_AIF]
        WHERE
            CAST(PRICING_DATE AS DATE) = %s
            AND LEFT(ORDERED_ITEM, 8) IN %s
    """

    params = [pricing_date, tuple(mercury_codes)]

    if customers:
        sql += " AND PARTY_NUMBER IN %s"
        params.append(tuple(customers))

    with connection.cursor() as cursor:
        cursor.execute(sql, params)
        rows = cursor.fetchall()
        columns = [col[0] for col in cursor.description]

    if not rows:
        return None

    # ðŸŸ¢ Create workbook in memory
    wb = Workbook()
    ws = wb.active
    ws.title = "Open Orders"

    ws.append(columns)

    for row in rows:
        ws.append(row)

    # ðŸŸ¢ Save into memory buffer
    buffer = BytesIO()
    wb.save(buffer)
    buffer.seek(0)

    return buffer

from django.core.mail import EmailMessage
from django.utils import timezone


def send_notification_with_attachment(self, aif):

    excel_buffer = self.generate_open_orders_attachment(aif)

    subject = f"AIF {aif.aif_id} - Open Orders Report"
    body = "Please find the attached Open Orders report."

    recipients = [aif.meta_created_by.email]  # adjust as needed

    email = EmailMessage(
        subject=subject,
        body=body,
        to=recipients
    )

    if excel_buffer:
        filename = f"OpenOrders_AIF_{aif.aif_id}_{timezone.now().strftime('%Y%m%d_%H%M')}.xlsx"

        email.attach(
            filename,
            excel_buffer.getvalue(),
            "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
        )

    email.send()













FORMAT(ORDERED_DATE, 'dd-MM-yyyy HH-mm') AS ORDERED_DATE

SELECT
    CAST(ORDERED_DATE AS DATE) AS ORDERED_DATE,
    ORDER_NUMBER,
    ORDER_LINE_NUMBER_DETAIL,
    ORDERED_ITEM,
    CAST(PRICING_DATE AS DATE) AS PRICING_DATE,
    UNIT_SELLING_PRICE,
    UNIT_LIST_PRICE,
    OPERATING_NAME,
    PARTY_NUMBER
FROM [PowerBI].[dbo].[OpenOrders_AIF]
WHERE
    CAST(PRICING_DATE AS DATE) = '2026-02-02'
    AND LEFT(ORDERED_ITEM, 8) IN ('4507C003', '0289C001')
    AND PARTY_NUMBER IN ('1035414', '1056789');

import io
from django.db import connections
from openpyxl import Workbook


def generate_open_orders_excel(aif: Aif) -> bytes | None:
    """
    Generates Excel attachment for Open Orders based on AIF.
    Returns file bytes or None if no data found.
    """

    mercury_codes = list(
        aif.aif_lines.values_list("mercury_code", flat=True)
    )
    if not mercury_codes:
        return None

    # Customers may or may not exist
    customers = list(
        aif.aif_customer_lines.values_list("oracle_cust_number", flat=True)
    )

    start_date = aif.start_date

    # ðŸ”¹ Build SQL dynamically
    sql = """
        SELECT
            ORDERED_DATE,
            ORDER_NUMBER,
            ORDER_LINE_NUMBER_DETAIL,
            ORDERED_ITEM,
            PRICING_DATE,
            UNIT_SELLING_PRICE,
            UNIT_LIST_PRICE,
            OPERATING_NAME,
            PARTY_NUMBER
        FROM [PowerBI].[dbo].[OpenOrders_AIF]
        WHERE
            PRICING_DATE >= %s
            AND LEFT(ORDERED_ITEM, 8) IN %s
    """

    params = [start_date, tuple(mercury_codes)]

    if customers:
        sql += " AND PARTY_NUMBER IN %s"
        params.append(tuple(customers))

    # ðŸ”¹ Execute query
    with connections["powerbi"].cursor() as cursor:
        cursor.execute(sql, params)
        rows = cursor.fetchall()
        columns = [col[0] for col in cursor.description]

    if not rows:
        return None

    # ðŸ”¹ Create Excel in memory
    wb = Workbook()
    ws = wb.active
    ws.title = "Open Orders"

    ws.append(columns)
    for row in rows:
        ws.append(row)

    buffer = io.BytesIO()
    wb.save(buffer)
    buffer.seek(0)

    return buffer.read()


attachments = []

excel_bytes = generate_open_orders_excel(aif)
if excel_bytes:
    attachments.append(
        (f"{aif.aif_id}_impacted_orders.xlsx", excel_bytes)
    )

if attachments:
    send_email_with_attachments(...)
else:
    send_email_to_group(...)
