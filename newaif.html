<div class="card-body">
    <h5 class="mb-3">Promotion Line Details</h5>

    <!-- Promotion Value -->
    <div class="row mb-4">
        <div class="col-md-4">
            <label class="form-label small text-muted">Promotion Value</label>
            <input type="text"
                   class="form-control form-control-sm"
                   :value="promoValue"
                   disabled>
        </div>
    </div>

    <!-- Header Row (Labels) -->
    <div class="row text-muted small fw-semibold mb-2">
        <div class="col-1">#</div>

        {% for field in aif_line_form.visible_fields %}
            <div class="col">
                <div>{{ field.label }}</div>
                {% if field.help_text %}
                    <div class="form-text small">{{ field.help_text|safe }}</div>
                {% endif %}
            </div>
        {% endfor %}

        <div class="col-auto text-center">Actions</div>
    </div>

    <!-- Lines -->
    <template v-for="line in lines" :key="line.id || lines.indexOf(line)">
        <form class="row g-2 align-items-start mb-2"
              :id="'lineform' + lines.indexOf(line)"
              @submit.prevent="">

            <!-- Line Number -->
            <div class="col-1 pt-2 small text-muted">
                [[ lines.indexOf(line) + 1 ]]
            </div>

            <!-- Dynamic Fields -->
            {% for field in aif_line_form.visible_fields %}
            <div class="col">
                {{ field|add_attrs:":index=lines.indexOf(line); v-model=lines; class=form-control form-control-sm; @change=handle_line_change(lines, lines.indexOf(line),$event); @paste.prevent=paste_mercury_from_excel(lines,lines.indexOf(line), $event);" }}
            </div>
            {% endfor %}

            <!-- Actions -->
            <div class="col-auto pt-1">
                <div class="btn-group btn-group-sm">
                    <button type="button"
                            class="btn btn-outline-primary"
                            @click="copy_line(line)">
                        <i class="bi bi-copy"></i>
                    </button>
                    <button type="button"
                            class="btn btn-outline-danger"
                            @click="delete_line(line)">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
            </div>

        </form>
    </template>

    <!-- Add Line Button -->
    <button type="button"
            class="btn btn-sm btn-primary mt-2"
            @click="add_line()">
        <i class="bi bi-plus-lg me-1"></i> Add Line
    </button>
</div>









<div class="card-body">
    <h5 class="card-title">Promotion Line Details</h5>

    <!-- Promotion Value -->
    <div class="row mb-3">
        <div class="col-md-4">
            <label class="form-label fw-semibold">Promotion Value</label>
            <input type="text"
                   class="form-control form-control-sm"
                   :value="promoValue"
                   disabled>
        </div>
    </div>

    <!-- Table -->
    <div class="table-responsive">
        <table class="table table-sm table-bordered align-middle">
            
            <!-- Header -->
            <thead class="table-light text-center small fw-normal">
                <tr>
                    <th style="width:50px;">#</th>

                    {% for field in aif_line_form.visible_fields %}
                        <th>
                            {{ field.label }}
                            {% if field.help_text %}
                                <div class="form-text small text-muted">
                                    {{ field.help_text|safe }}
                                </div>
                            {% endif %}
                        </th>
                    {% endfor %}

                    <!-- ðŸ”¥ New Actions Column -->
                    <th style="width:110px;">Actions</th>
                </tr>
            </thead>

            <!-- Body -->
            <tbody>
                <template v-for="line in lines" :key="line.id || lines.indexOf(line)">
                    <tr>
                        <td class="text-center">
                            [[ lines.indexOf(line) + 1 ]]
                        </td>

                        {% for field in aif_line_form.visible_fields %}
                        <td>
                            {{ field|add_attrs:":index=lines.indexOf(line); v-model=lines; @change=handle_line_change(lines, lines.indexOf(line),$event); @paste.prevent=paste_mercury_from_excel(lines,lines.indexOf(line), $event);" }}
                        </td>
                        {% endfor %}

                        <!-- ðŸ”¥ Actions Buttons -->
                        <td class="text-center">
                            <div class="btn-group btn-group-sm">
                                <button type="button"
                                        class="btn btn-outline-primary"
                                        @click="copy_line(line)">
                                    <i class="bi bi-copy"></i>
                                </button>
                                <button type="button"
                                        class="btn btn-outline-danger"
                                        @click="delete_line(line)">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                </template>
            </tbody>
        </table>
    </div>

    <!-- Add Line Button -->
    <button type="button"
            class="btn btn-sm btn-primary mt-2"
            @click="add_line()">
        <i class="bi bi-plus-lg me-1"></i> Add Line
    </button>
</div>




<div class="col-md-6">
    <form id="aif_form" @submit.prevent="">
        <div class="section-title mb-3">Promotion Details</div>

        <div class="row g-2 align-items-center">

            {% for field in aif_form.visible_fields %}
            <div class="col-4">
                <label class="form-label fw-semibold mb-0">
                    {{ field.label }}
                </label>
            </div>

            <div class="col-8">
                {% if field.name == "nso" %}
                    {{ field|add_attrs:"v-model=aif; @change=onNSOChange; class=form-select form-select-sm" }}

                {% elif field.name == "is_all_nso_enabled" %}
                    <div class="form-check form-switch">
                        {{ field|add_attrs:"v-model=aif; @change=onNSOMarketSelect; class=form-check-input" }}
                        <span class="small text-muted ms-2">
                            {{ field.help_text|safe }}
                        </span>
                    </div>

                {% else %}
                    {{ field|add_attrs:"v-model=aif; class=form-control form-control-sm" }}
                {% endif %}
            </div>
            {% endfor %}

            <!-- File Upload Row -->
            <div class="col-4">
                <label class="form-label fw-semibold mb-0">File Attachment</label>
            </div>
            <div class="col-8">
                <input type="file"
                       class="form-control form-control-sm"
                       id="file_aif"
                       accept="image/*, application/pdf"
                       multiple>

                <div class="form-text">
                    File will be uploaded to
                    <a :href="encodeURI('{{ site_address|safe }}{{ library }}')" target="_blank">
                        SharePoint
                    </a>
                </div>
            </div>

        </div>
    </form>
</div>














<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
     stroke-linecap="round" stroke-linejoin="round">
  <circle cx="12" cy="12" r="9"></circle>
  <polyline points="12 7 12 12 15














<ul v-if="customer_name_search_results[lineIndex]?.length"
    class="list-group mt-1"
    style="max-height: 220px; overflow-y: auto;">

    <li v-for="cust in customer_name_search_results[lineIndex]"
        :key="cust.party_number"
        class="list-group-item list-group-item-action small"
        style="cursor:pointer;"
        @click="selectCustomerName(lineIndex, cust)">

        [[ cust.label ]]
    </li>

</ul>


=== Promotion Basics ===
Promotion Campaign
Promotion Category
Promotion Activity

=== Market Scope ===
NSO
[ ] Apply to All NSO Market

=== Timeline ===
Start Date     End Date

=== Financial Info ===
Local Currency (auto)

=== Special Handling ===
AIF To Be Cancelled

=== Notifications ===
Email CC

=== Attachments ===
File Upload
(File will be uploaded to SharePoint)



<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
     stroke-linecap="round" stroke-linejoin="round">
  <rect x="9" y="2" width="6" height="4" rx="1"></rect>
  <path d="M5 6h14a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2z"></path>
  <line x1="9" y1="12" x2="15" y2="12"></line>
  <line x1="9" y1="16" x2="13" y2="16"></line>
</svg>


NSO_CURRENCY_MAP = {
    "NSO Austria": "EUR",
    "NSO Belgium": "EUR",
    "NSO Czech": "CZK",
    "NSO Denmark": "DKK",
    "NSO Finland": "EUR",
    "NSO France": "EUR",
    "NSO Germany": "EUR",
    "NSO Hungary": "HUF",
    "NSO Ireland": "EUR",
    "NSO Italy": "EUR",
    "NSO Netherlands": "EUR",
    "NSO Norway": "NOK",
    "NSO Poland": "PLN",
    "NSO Portugal": "EUR",
    "NSO Slovakia": "EUR",
    "NSO Spain": "EUR",
    "NSO Sweden": "SEK",
    "NSO Switzerland": "CHF",
    "NSO UK": "GBP",
    "RSO Russia": "RUB",
    "CEL": "EUR",
}

class AifForm(forms.ModelForm):

    class Meta:
        model = Aif
        fields = "__all__"

    def clean(self):
        cleaned_data = super().clean()
        nso = cleaned_data.get("nso")

        # Auto assign currency based on NSO
        if nso:
            cleaned_data["local_currency"] = NSO_CURRENCY_MAP.get(nso, "EUR")

        return cleaned_data

      self.fields["local_currency"].widget.attrs["readonly"] = True

