<td>
  <span v-if="!item?.aif_status" class="spinner-grow spinner-grow-sm"></span>

  <div v-else class="d-flex align-items-center gap-2">
    <i :class="status_icon(get_aif_status(item))" class="fs-5"></i>
    <span class="fw-semibold">[[ format_status_label(get_aif_status(item)) ]]</span>
  </div>
</td>
<td>
  <span v-if="!item?.aif_status" class="spinner-grow spinner-grow-sm"></span>

  <div v-else :class="status_chip_class(get_aif_status(item))">
    <span v-html="status_svg(get_aif_status(item))" class="me-1 d-inline-flex align-items-center"></span>
    <span>[[ format_status_label(get_aif_status(item)) ]]</span>
  </div>
</td>

status_svg(status) {
  switch (status) {
    case "DRAFT":
      return `<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M3 17.25V21h3.75L19.81 7.94l-3.75-3.75L3 17.25z"/>
                <path d="M20.71 6.04a1 1 0 0 0 0-1.41l-1.34-1.34a1 1 0 0 0-1.41 0l-1.13 1.13 3.75 3.75 1.13-1.13z"/>
              </svg>`;

    case "PLANNED":
      return `<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 4h-1V2h-2v2H8V2H6v2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2zm0 16H5V9h14v11z"/>
              </svg>`;

    case "AWAITING_VALIDATION":
      return `<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <circle cx="12" cy="12" r="9" opacity="0.2">
                  <animate attributeName="opacity" values="0.2;0.6;0.2" dur="1.5s" repeatCount="indefinite"/>
                </circle>
                <path d="M12 6v6l4 2"/>
              </svg>`;

    case "COMMERCIALLY_APPROVED":
      return `<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M9 16.2 4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4z"/>
              </svg>`;

    case "INVALID":
      return `<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm5 13.6L15.6 17 12 13.4 8.4 17 7 15.6 10.6 12 7 8.4 8.4 7 12 10.6 15.6 7 17 8.4 13.4 12z"/>
              </svg>`;

    case "CLOSED":
      return `<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2a5 5 0 0 0-5 5v3H6a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8a2 2 0 0 0-2-2h-1V7a5 5 0 0 0-5-5zm-3 8V7a3 3 0 0 1 6 0v3z"/>
              </svg>`;

    default:
      return `<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <circle cx="12" cy="12" r="10"/>
              </svg>`;
  }
}

status_icon(status) {
  switch (status) {
    case "DRAFT":
      return "bi bi-pencil-square text-secondary";

    case "PLANNED":
      return "bi bi-calendar-check text-primary";

    case "AWAITING_VALIDATION":
      return "bi bi-hourglass-split text-warning";

    case "COMMERCIALLY_APPROVED":
      return "bi bi-check-circle-fill text-success";

    case "INVALID":
      return "bi bi-x-circle-fill text-danger";

    case "CLOSED":
      return "bi bi-lock-fill text-dark";

    default:
      return "bi bi-question-circle text-muted";
  }
},

format_status_label(status) {
  if (!status) return "";

  return status
    .replaceAll("_", " ")
    .toLowerCase()
    .replace(/\b\w/g, l => l.toUpperCase());
}









<div class="btn-group btn-group-sm">

    <!-- SharePoint -->
    <a :href="item.link"
       target="_blank"
       class="btn btn-outline-dark"
       title="Open SharePoint">
        <i class="bi bi-share"></i>
    </a>

    <!-- Edit -->
    <button v-if="['DRAFT', 'REJECTED'].includes(get_aif_status(item))"
            type="button"
            class="btn btn-outline-primary"
            title="Edit AIF"
            @click="select_aif_and_navigate(item, 'aif_app', 'edit')">
        <i class="bi bi-pencil"></i>
    </button>

    <!-- Delete -->
    <button v-if="['DRAFT', 'REJECTED'].includes(get_aif_status(item))"
            type="button"
            class="btn btn-outline-danger"
            title="Delete AIF"
            @click="selected_aif = item; toggle_modal('modal_confirm_delete');">
        <i class="bi bi-x-lg"></i>
    </button>

    <!-- View -->
    <button type="button"
            class="btn btn-outline-secondary"
            title="View AIF"
            @click="select_aif_and_navigate(item, 'aif_view'); checked_lines = [];">
        <i class="bi bi-eye"></i>
    </button>

    <!-- Use as Template -->
    <button type="button"
            class="btn btn-outline-warning"
            title="Use As Template"
            @click="select_aif_and_navigate(item, 'aif_app', 'template')">
        <i class="bi bi-copy"></i>
    </button>

</div>







handle_line_change(line, index, event) {
    this.changes.edited_lines.add(this.lines[index].id);

    const model_column = event.target.getAttribute("name");
    const value = event.target.value;

    switch (model_column) {

        case "mercury_code":
            this.handle_mercury_change(line, index, value);
            break;

        case "promotional_qty":
            line.promotional_qty = value;
            if (line.promotional_qty && line.promotional_elp) {
                this.calculatePromotionValues(line);
            }
            break;

        case "promotional_elp":
            line.promotional_elp = Number(value);
            if (line.promotional_qty && line.promotional_elp) {
                this.calculatePromotionValues(line);
            }
            break;

        default:
            // no special handling required
            break;
    }
}





handle_mercury_change(lines, index, mercury) {
    if (!mercury) return Promise.resolve(false);

    const line = lines[index];

    return fetch(`${api_endpoints.pdh_product_hierarchy}?mercury_1st_layer_8_char_field=${encodeURIComponent(mercury)}`)
        .then(res => {
            if (!res.ok) return Promise.reject(res);
            return res.json();
        })
        .then(data => {
            // âŒ Mercury not found
            if (!data || !data.length) {
                this.invalidMercuries.push(mercury);
                return false;
            }

            // âœ… Mercury found â†’ update fields
            const product = data[0];
            line.product_group = product.cemis_group;
            line.product_description = product.productname || product.description;

            // âœ… Now fetch ELP price ONLY if mercury valid
            return this.handle_elp_price(lines, index, mercury).then(() => true);
        })
        .catch(err => {
            this.display_error(err, "Failed to load Mercury Details");
            return false;
        });
}




this.invalidMercuries = [];
if (this.invalidMercuries.length) {
        this.dialog.reset_to_default()
            .set_title("Invalid Mercury Codes")
            .set_message(
                `These mercury codes are not set up in MDM PDH:\n\n${this.invalidMercuries.join(", ")}`
            )
            .set_true_action("Close")
            .show();
    }


paste_mercury_from_excel(line_item, index, event) {
    this.reset_mercury_error();

    const text = event.clipboardData.getData("text/plain");
    const copied_lines = text.trim().split(/\r?\n/);
    if (!copied_lines.length) return;

    for (let i = 0; i < copied_lines.length; i++) {
        const mercury = copied_lines[i].split("\t")[0]?.trim();
        if (!mercury || !/^[a-zA-Z0-9]+$/.test(mercury)) {
            this.showExcelValidationError(i, "Mercury Code must be alphanumeric and not blank.");
            return;
        }
    }

    copied_lines.forEach((row, lineIndex) => {
        const mercury = row.split("\t")[0]?.trim();
        const targetIndex = index + lineIndex;

        line_item[targetIndex] = line_item[targetIndex] || {};

        if (this.nav_state.context === "edit") {
            line_item[targetIndex]["id"] = "temp";
        }

        line_item[targetIndex]["mercury_code"] = mercury;

        // ðŸ”¥ Chain calls â€” only load ELP if mercury valid
        this.handle_mercury_change(line_item, targetIndex, mercury)
            .then(isValid => {
                if (isValid) {
                    return this.handle_elp_price(line_item, targetIndex, mercury);
                }
            });
    });
}





<div class="row align-items-center mb-3">
    <div class="col-md-3">
        <label class="form-label small text-muted mb-0">Promotion Value</label>
    </div>
    <div class="col-md-6">
        <input type="text"
               class="form-control form-control-sm"
               :value="promoValue"
               disabled>
    </div>
</div>



<div class="card-body">
    <h5 class="mb-3">Promotion Line Details</h5>

    <!-- Promotion Value -->
    <div class="row mb-4">
        <div class="col-md-4">
            <label class="form-label small text-muted">Promotion Value</label>
            <input type="text"
                   class="form-control form-control-sm"
                   :value="promoValue"
                   disabled>
        </div>
    </div>

    <!-- Header Row (Labels) -->
    <div class="row text-muted small fw-semibold mb-2">
        <div class="col-1">#</div>

        {% for field in aif_line_form.visible_fields %}
            <div class="col">
                <div>{{ field.label }}</div>
                {% if field.help_text %}
                    <div class="form-text small">{{ field.help_text|safe }}</div>
                {% endif %}
            </div>
        {% endfor %}

        <div class="col-auto text-center">Actions</div>
    </div>

    <!-- Lines -->
    <template v-for="line in lines" :key="line.id || lines.indexOf(line)">
        <form class="row g-2 align-items-start mb-2"
              :id="'lineform' + lines.indexOf(line)"
              @submit.prevent="">

            <!-- Line Number -->
            <div class="col-1 pt-2 small text-muted">
                [[ lines.indexOf(line) + 1 ]]
            </div>

            <!-- Dynamic Fields -->
            {% for field in aif_line_form.visible_fields %}
            <div class="col">
                {{ field|add_attrs:":index=lines.indexOf(line); v-model=lines; class=form-control form-control-sm; @change=handle_line_change(lines, lines.indexOf(line),$event); @paste.prevent=paste_mercury_from_excel(lines,lines.indexOf(line), $event);" }}
            </div>
            {% endfor %}

            <!-- Actions -->
            <div class="col-auto pt-1">
                <div class="btn-group btn-group-sm">
                    <button type="button"
                            class="btn btn-outline-primary"
                            @click="copy_line(line)">
                        <i class="bi bi-copy"></i>
                    </button>
                    <button type="button"
                            class="btn btn-outline-danger"
                            @click="delete_line(line)">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
            </div>

        </form>
    </template>

    <!-- Add Line Button -->
    <button type="button"
            class="btn btn-sm btn-primary mt-2"
            @click="add_line()">
        <i class="bi bi-plus-lg me-1"></i> Add Line
    </button>
</div>









<div class="card-body">
    <h5 class="card-title">Promotion Line Details</h5>

    <!-- Promotion Value -->
    <div class="row mb-3">
        <div class="col-md-4">
            <label class="form-label fw-semibold">Promotion Value</label>
            <input type="text"
                   class="form-control form-control-sm"
                   :value="promoValue"
                   disabled>
        </div>
    </div>

    <!-- Table -->
    <div class="table-responsive">
        <table class="table table-sm table-bordered align-middle">
            
            <!-- Header -->
            <thead class="table-light text-center small fw-normal">
                <tr>
                    <th style="width:50px;">#</th>

                    {% for field in aif_line_form.visible_fields %}
                        <th>
                            {{ field.label }}
                            {% if field.help_text %}
                                <div class="form-text small text-muted">
                                    {{ field.help_text|safe }}
                                </div>
                            {% endif %}
                        </th>
                    {% endfor %}

                    <!-- ðŸ”¥ New Actions Column -->
                    <th style="width:110px;">Actions</th>
                </tr>
            </thead>

            <!-- Body -->
            <tbody>
                <template v-for="line in lines" :key="line.id || lines.indexOf(line)">
                    <tr>
                        <td class="text-center">
                            [[ lines.indexOf(line) + 1 ]]
                        </td>

                        {% for field in aif_line_form.visible_fields %}
                        <td>
                            {{ field|add_attrs:":index=lines.indexOf(line); v-model=lines; @change=handle_line_change(lines, lines.indexOf(line),$event); @paste.prevent=paste_mercury_from_excel(lines,lines.indexOf(line), $event);" }}
                        </td>
                        {% endfor %}

                        <!-- ðŸ”¥ Actions Buttons -->
                        <td class="text-center">
                            <div class="btn-group btn-group-sm">
                                <button type="button"
                                        class="btn btn-outline-primary"
                                        @click="copy_line(line)">
                                    <i class="bi bi-copy"></i>
                                </button>
                                <button type="button"
                                        class="btn btn-outline-danger"
                                        @click="delete_line(line)">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                </template>
            </tbody>
        </table>
    </div>

    <!-- Add Line Button -->
    <button type="button"
            class="btn btn-sm btn-primary mt-2"
            @click="add_line()">
        <i class="bi bi-plus-lg me-1"></i> Add Line
    </button>
</div>




<div class="col-md-6">
    <form id="aif_form" @submit.prevent="">
        <div class="section-title mb-3">Promotion Details</div>

        <div class="row g-2 align-items-center">

            {% for field in aif_form.visible_fields %}
            <div class="col-4">
                <label class="form-label fw-semibold mb-0">
                    {{ field.label }}
                </label>
            </div>

            <div class="col-8">
                {% if field.name == "nso" %}
                    {{ field|add_attrs:"v-model=aif; @change=onNSOChange; class=form-select form-select-sm" }}

                {% elif field.name == "is_all_nso_enabled" %}
                    <div class="form-check form-switch">
                        {{ field|add_attrs:"v-model=aif; @change=onNSOMarketSelect; class=form-check-input" }}
                        <span class="small text-muted ms-2">
                            {{ field.help_text|safe }}
                        </span>
                    </div>

                {% else %}
                    {{ field|add_attrs:"v-model=aif; class=form-control form-control-sm" }}
                {% endif %}
            </div>
            {% endfor %}

            <!-- File Upload Row -->
            <div class="col-4">
                <label class="form-label fw-semibold mb-0">File Attachment</label>
            </div>
            <div class="col-8">
                <input type="file"
                       class="form-control form-control-sm"
                       id="file_aif"
                       accept="image/*, application/pdf"
                       multiple>

                <div class="form-text">
                    File will be uploaded to
                    <a :href="encodeURI('{{ site_address|safe }}{{ library }}')" target="_blank">
                        SharePoint
                    </a>
                </div>
            </div>

        </div>
    </form>
</div>














<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
     stroke-linecap="round" stroke-linejoin="round">
  <circle cx="12" cy="12" r="9"></circle>
  <polyline points="12 7 12 12 15














<ul v-if="customer_name_search_results[lineIndex]?.length"
    class="list-group mt-1"
    style="max-height: 220px; overflow-y: auto;">

    <li v-for="cust in customer_name_search_results[lineIndex]"
        :key="cust.party_number"
        class="list-group-item list-group-item-action small"
        style="cursor:pointer;"
        @click="selectCustomerName(lineIndex, cust)">

        [[ cust.label ]]
    </li>

</ul>


=== Promotion Basics ===
Promotion Campaign
Promotion Category
Promotion Activity

=== Market Scope ===
NSO
[ ] Apply to All NSO Market

=== Timeline ===
Start Date     End Date

=== Financial Info ===
Local Currency (auto)

=== Special Handling ===
AIF To Be Cancelled

=== Notifications ===
Email CC

=== Attachments ===
File Upload
(File will be uploaded to SharePoint)



<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
     stroke-linecap="round" stroke-linejoin="round">
  <rect x="9" y="2" width="6" height="4" rx="1"></rect>
  <path d="M5 6h14a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2z"></path>
  <line x1="9" y1="12" x2="15" y2="12"></line>
  <line x1="9" y1="16" x2="13" y2="16"></line>
</svg>


NSO_CURRENCY_MAP = {
    "NSO Austria": "EUR",
    "NSO Belgium": "EUR",
    "NSO Czech": "CZK",
    "NSO Denmark": "DKK",
    "NSO Finland": "EUR",
    "NSO France": "EUR",
    "NSO Germany": "EUR",
    "NSO Hungary": "HUF",
    "NSO Ireland": "EUR",
    "NSO Italy": "EUR",
    "NSO Netherlands": "EUR",
    "NSO Norway": "NOK",
    "NSO Poland": "PLN",
    "NSO Portugal": "EUR",
    "NSO Slovakia": "EUR",
    "NSO Spain": "EUR",
    "NSO Sweden": "SEK",
    "NSO Switzerland": "CHF",
    "NSO UK": "GBP",
    "RSO Russia": "RUB",
    "CEL": "EUR",
}

class AifForm(forms.ModelForm):

    class Meta:
        model = Aif
        fields = "__all__"

    def clean(self):
        cleaned_data = super().clean()
        nso = cleaned_data.get("nso")

        # Auto assign currency based on NSO
        if nso:
            cleaned_data["local_currency"] = NSO_CURRENCY_MAP.get(nso, "EUR")

        return cleaned_data

      self.fields["local_currency"].widget.attrs["readonly"] = True

