<div
  class="d-inline-block"
  :title="!canActOnLine(line) ? 'You are not authorized for this Product Group' : ''"
  @click="showPermissionError(line)"
>
  <input
    class="form-check-input"
    type="checkbox"
    :disabled="!canActOnLine(line)"
    :checked="checked_lines.includes(line)"
  >
</div>


showPermissionError(line) {
  if (!this.canActOnLine(line)) {
    this.dialog
      .reset_to_default()
      .set_title("Permission denied")
      .set_message(
        `You are not authorized to act on Product Group "${line.product_group}".`
      )
      .set_true_action("Close")
      .show();
  }
}

<div
  class="d-inline-block"
  data-bs-toggle="tooltip"
  data-bs-placement="top"
  :data-bs-title="!canActOnLine(line) ? 'You are not authorized for this Product Group' : ''"
  @click="showPermissionError(line)"
>
  <input
    class="form-check-input"
    type="checkbox"
    :disabled="!canActOnLine(line)"
    :checked="checked_lines.includes(line)"
  >
</div>


select_all_lines(event) {
  if (!event.target.checked) {
    this.checked_lines = [];
    return;
  }

  const validLines = [];

  for (const line of this.selected_aif.aif_lines) {
    if (this.get_line_status(line)?.status !== 'AWAITING_APPROVAL') continue;

    if (!this.canActOnLine(line)) {
      event.target.checked = false;

      this.dialog
        .reset_to_default()
        .set_title("Permission denied")
        .set_message(
          `You are not authorized to act on Line ID ${line.id}
(Product Group: ${line.product_group}).`
        )
        .set_true_action("Close")
        .show();

      return;
    }

    validLines.push(line);
  }

  this.checked_lines = validLines;
}



select_all_lines(event) {
  // Uncheck → clear everything
  if (!event.target.checked) {
    this.checked_lines = [];
    return;
  }

  const validLines = [];
  const unauthorizedLines = [];

  for (const line of this.selected_aif.aif_lines) {
    if (this.get_line_status(line)?.status !== 'AWAITING_APPROVAL') {
      continue;
    }

    if (this.canActOnLine(line)) {
      validLines.push(line);
    } else {
      unauthorizedLines.push(line);
    }
  }

  // ✅ Check only allowed lines
  this.checked_lines = validLines;

  // ⚠ Show warning if some lines were skipped
  if (unauthorizedLines.length > 0) {
    const message = unauthorizedLines
      .map(
        l => `Line ID ${l.id} (Product Group: ${l.product_group})`
      )
      .join("<br>");

    this.dialog
      .reset_to_default()
      .set_title("Some lines were not selected")
      .set_message(
        `You don’t have permission to act on the following line(s):<br><br>${message}`
      )
      .set_true_action("Close")
      .show();
  }
}

select_all_lines(event) {
  // Uncheck → clear selection
  if (!event.target.checked) {
    this.checked_lines = [];
    return;
  }

  const validLines = [];
  const unauthorizedLines = [];

  for (const line of this.selected_aif.aif_lines) {
    if (this.get_line_status(line)?.status !== 'AWAITING_APPROVAL') continue;

    if (this.canActOnLine(line)) {
      validLines.push(line);
    } else {
      unauthorizedLines.push(line);
    }
  }

  // ❌ NO authorized lines → uncheck select-all
  if (validLines.length === 0) {
    event.target.checked = false;
    this.checked_lines = [];

    this.dialog
      .reset_to_default()
      .set_title("Permission denied")
      .set_message(
        "You don’t have permission to act on any of the selected lines."
      )
      .set_true_action("Close")
      .show();

    return;
  }

  // ✅ Some authorized lines → select them
  this.checked_lines = validLines;

  // ⚠ Show warning if some lines were skipped
  if (unauthorizedLines.length > 0) {
    const message = unauthorizedLines
      .map(l => `Line ${l.id} (${l.product_group})`)
      .join(" | ");

    this.dialog
      .reset_to_default()
      .set_title("Some lines were not selected")
      .set_message(
        "You don’t have permission for the following lines: " + message
      )
      .set_true_action("Close")
      .show();
  }
}

