async buildWebEDIHeaderRows({
  sourceAIF,        // where lines/customers come from
  effectiveAIF,     // dates + aif_id + nso
  trxType           // "UPDATE" | "INSERT"
}) {
  if (!sourceAIF?.aif_lines?.length) return;

  const opUnit = await this.getOperationUnitByNSO(effectiveAIF.nso);

  const hasCustomers =
    Array.isArray(sourceAIF.aif_customer_lines) &&
    sourceAIF.aif_customer_lines.length > 0;

  // =========================
  // CASE 1: NO CUSTOMERS
  // =========================
  if (!hasCustomers) {
    sourceAIF.aif_lines.forEach(line => {
      this.ws_data.push([
        opUnit,
        trxType,
        this.buildModifierLineNo(line, effectiveAIF), // no customer
        "LINE",
        "Discount",
        this.formatExcelDates(effectiveAIF.start_date),
        this.formatExcelDates(
          trxType === "UPDATE"
            ? effectiveAIF.start_date
            : effectiveAIF.end_date
        ),
        "Y",
        "N",
        "List Line Adjustment",
        "Level 4 Incompatibility",
        1,
        "First Layer",
        line.mercury_code,
        100,
        "LOCAL",
        "",
        "New Price",
        Number(line.promotional_elp) || 0,
        "N"
      ]);
    });
    return;
  }

  // =========================
  // CASE 2: CUSTOMERS EXIST
  // =========================
  sourceAIF.aif_customer_lines.forEach(customer => {
    const customerId = customer.oracle_cust_number;

    sourceAIF.aif_lines.forEach(line => {
      this.ws_data.push([
        opUnit,
        trxType,
        this.buildModifierLineNo(line, effectiveAIF, customerId),
        "LINE",
        "Discount",
        this.formatExcelDates(effectiveAIF.start_date),
        this.formatExcelDates(
          trxType === "UPDATE"
            ? effectiveAIF.start_date
            : effectiveAIF.end_date
        ),
        "Y",
        "N",
        "List Line Adjustment",
        "Level 4 Incompatibility",
        1,
        "First Layer",
        line.mercury_code,
        100,
        "LOCAL",
        "",
        "New Price",
        Number(line.promotional_elp) || 0,
        "N"
      ]);
    });
  });
}





async load_aifs_for_cancellation(aifIds = []) {
  const aifs_cancellation_list = [];

  for (const aifId of aifIds) {
    let aifData = null;

    // 1Ô∏è‚É£ Load AIF (base object)
    await fetch(api_endpoints.aif + aifId + "/")
      .then(res => res.json())
      .then(data => {
        aifData = data;
      });

    if (!aifData) continue;

    // 2Ô∏è‚É£ Attach AIF lines (same key as current AIF)
    await fetch(api_endpoints.aif_lines + "?aif=" + aifId)
      .then(res => res.json())
      .then(data => {
        aifData.aif_lines = data;
      });

    // 3Ô∏è‚É£ Attach customer lines (same key as current AIF)
    await fetch(api_endpoints.aif_customer_line + "?aif=" + aifId)
      .then(res => res.json())
      .then(data => {
        aifData.aif_customer_lines = data;
      });

    // ‚úÖ Push in SAME SHAPE as selected_aif
    aifs_cancellation_list.push(aifData);
  }

  return aifs_cancellation_list;
}





async buildWebEDIHeaderRows({
  sourceAIF,        // where lines/customers come from
  effectiveAIF,     // whose dates & aif_id apply
  trxType           // "UPDATE" | "INSERT"
}) {
  if (!sourceAIF?.aif_lines?.length) return;

  // üîë OpUnit resolved from EFFECTIVE AIF
  const opUnit = await this.getOperationUnitByNSO(effectiveAIF.nso);

  const customers =
    sourceAIF.aif_customer_lines?.length
      ? sourceAIF.aif_customer_lines
      : [null];

  customers.forEach(customer => {
    const customerId = customer?.oracle_cust_number || null;

    sourceAIF.aif_lines.forEach(line => {
      this.ws_data.push([
        opUnit,
        trxType,
        this.buildModifierLineNo(line, effectiveAIF, customerId),
        "LINE",
        "Discount",
        this.formatExcelDates(effectiveAIF.start_date),
        this.formatExcelDates(
          trxType === "UPDATE"
            ? effectiveAIF.start_date
            : effectiveAIF.end_date
        ),
        "Y",
        "N",
        "List Line Adjustment",
        "Level 4 Incompatibility",
        1,
        "First Layer",
        line.mercury_code,
        100,
        "LOCAL",
        "",
        "New Price",
        Number(line.promotional_elp) || 0,
        "N"
      ]);
    });
  });
}










async load_aifs_for_cancellation(aifIds = []) {
    this.aifs_for_cancellation = [];

    for (const aifId of aifIds) {
        const aifObj = {};

        // 1Ô∏è‚É£ AIF header
        await fetch(api_endpoints.aif + aifId + "/")
            .then(response => response.json())
            .then(data => {
                aifObj.aif = data;
            });

        // 2Ô∏è‚É£ AIF lines
        await fetch(api_endpoints.aif_lines + "?aif=" + aifId)
            .then(response => response.json())
            .then(data => {
                aifObj.aif_lines = data;
            });

        // 3Ô∏è‚É£ AIF customer lines
        await fetch(api_endpoints.aif_customer_line + "?aif=" + aifId)
            .then(response => response.json())
            .then(data => {
                aifObj.aif_customer_lines = data;
            });

        // 4Ô∏è‚É£ Store fully prepared AIF
        this.aifs_for_cancellation.push(aifObj);
    }
}
