from django.contrib import admin
from django.utils import timezone
from django.contrib.auth.models import Group

@admin.register(AifApprover)
class AifApproverAdmin(admin.ModelAdmin):
    save_as = True
    form = AifApproverAdminForm

    list_display = (
        "id",
        "product_group",
        "responsibility",
        "approver_email",
        "meta_edited_date",
    )

    list_filter = ("product_group", "responsibility")

    search_fields = (
        "approver__username",
        "approver__email",
        "product_group",
    )

    readonly_fields = (
        "meta_edited_date",
        "meta_edited_by",
    )

    exclude = ("meta_edited_by",)

    def save_model(self, request, obj, form, change):
        if change:
            obj.meta_edited_by = request.user
            obj.meta_edited_date = timezone.now()

        super().save_model(request, obj, form, change)

        psbd_group, _ = Group.objects.get_or_create(name=PSBD_TEAM_USER)
        if not obj.approver.groups.filter(name=PSBD_TEAM_USER).exists():
            obj.approver.groups.add(psbd_group)

    def has_delete_permission(self, request, obj=None):
        return request.user.groups.filter(name=ADMIN_ROLE).exists()

    def has_change_permission(self, request, obj=None):
        return request.user.groups.filter(name=ADMIN_ROLE).exists()

    def has_add_permission(self, request, obj=None):
        return request.user.groups.filter(name=ADMIN_ROLE).exists()

    def approver_email(self, obj):
        return obj.approver.email

    approver_email.short_description = "Approver Email"


/////////////////////////////////////

computed: {
  groupedApprovers() {
    const result = {};

    this.aif_approvers.forEach(item => {
      const pg = item.product_group;
      const resp = item.responsibility;

      if (!result[pg]) {
        result[pg] = {};
      }

      if (!result[pg][resp]) {
        result[pg][resp] = [];
      }

      result[pg][resp].push(item.email);
    });

    return result;
  }
}

<div class="row g-3">

  <template v-for="(responsibilities, productGroup) in groupedApprovers" :key="productGroup">
    <template v-for="(emails, responsibility) in responsibilities" :key="responsibility">

      <div class="col-md-6">
        <div class="card h-100">
          <div class="card-body">
            <h6 class="card-title mb-2">
              Product Group: <strong>[[ productGroup ]]</strong>
            </h6>

            <p class="mb-1">
              Responsibility: <strong>[[ responsibility ]]</strong>
            </p>

            <hr>

            <ul class="mb-0">
              <li v-for="email in emails" :key="email">
                [[ email ]]
              </li>
            </ul>
          </div>
        </div>
      </div>

    </template>
  </template>

</div>





<div class="row g-3">
  <template v-for="(responsibilities, productGroup) in groupedApprovers" :key="productGroup">
    <template v-for="(emails, responsibility) in responsibilities" :key="responsibility">

      <div class="col-md-4">
        <div class="card h-100">
          <div class="card-body">

            <h6 class="card-title mb-3">
              [[ productGroup ]]
            </h6>

            <div class="mb-2">
              <small class="text-muted">Product Group</small>
              <div>[[ productGroup ]]</div>
            </div>

            <div class="mb-2">
              <small class="text-muted">Responsibility</small>
              <div>[[ responsibility ]]</div>
            </div>

            <div class="mb-0">
              <small class="text-muted">Emails</small>
              <div>
                [[ emails.join('; ') ]]
              </div>
            </div>

          </div>
        </div>
      </div>

    </template>
  </template>
</div>


if (item.meta_edited_by) {
      result[pg][resp].modified_by =
        `${item.meta_edited_by.first_name} ${item.meta_edited_by.last_name}`.trim()
        || item.meta_edited_by.email;

      result[pg][resp].modified_at = item.meta_edited_date;
    }


<div class="mb-0" v-if="group.modified_by">
  <small class="text-muted">Modified By</small>
  <div>
    <strong>[[ group.modified_by ]]</strong>
    <span class="text-muted" v-if="group.modified_at">
      â€” [[ new Date(group.modified_at).toLocaleString() ]]
    </span>
  </div>
